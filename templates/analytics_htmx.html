<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{{.Title}}</title>
    <script>
        // Apply dark theme by default
        (function() {
            const savedTheme = localStorage.getItem('theme') || 'dark';
            if (savedTheme === 'light') {
                document.documentElement.setAttribute('data-theme', 'light');
            }
        })();
    </script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@300;400;500;700&display=block" rel="stylesheet">
    <script src="https://unpkg.com/htmx.org@1.9.10"></script>
    <link rel="stylesheet" href="/static/style.css">
    <style>
        .analytics-container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }
        
        .analytics-header {
            text-align: center;
            margin-bottom: 30px;
        }
        
        .analytics-header h1 {
            font-size: 2.5rem;
            margin-bottom: 10px;
            color: var(--text-primary);
        }
        
        .season-selector {
            display: flex;
            gap: 20px;
            align-items: center;
            justify-content: center;
            margin-bottom: 30px;
            padding: 20px;
            background: var(--bg-secondary);
            border-radius: 12px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
        }
        
        .selector-group {
            display: flex;
            flex-direction: column;
            gap: 8px;
            align-items: center;
        }
        
        .selector-group label {
            font-weight: 500;
            color: var(--text-secondary);
            font-size: 0.9rem;
        }
        
        .selector-group select, .selector-group input {
            padding: 8px 12px;
            border: 1px solid var(--border-color);
            border-radius: 6px;
            background: var(--bg-primary);
            color: var(--text-primary);
            font-size: 14px;
        }
        
        .analytics-grid {
            display: grid;
            grid-template-columns: 1fr;
            gap: 30px;
        }
        
        .analytics-section {
            background: var(--bg-secondary);
            border-radius: 12px;
            padding: 25px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
        }
        
        .analytics-section h2 {
            margin-bottom: 20px;
            color: var(--text-primary);
            font-size: 1.5rem;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .stats-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 15px;
        }
        
        .stats-table th,
        .stats-table td {
            text-align: left;
            padding: 12px;
            border-bottom: 1px solid var(--border-color);
        }
        
        .stats-table th {
            background: var(--bg-tertiary);
            font-weight: 600;
            color: var(--text-secondary);
            font-size: 0.9rem;
        }
        
        .stats-table td {
            color: var(--text-primary);
        }
        
        .stats-table tr:hover {
            background: var(--bg-tertiary);
        }
        
        .record {
            font-family: monospace;
            font-size: 0.9rem;
        }
        
        .win-pct {
            font-weight: 600;
        }
        
        .win-pct.good { color: #10b981; }
        .win-pct.ok { color: #f59e0b; }
        .win-pct.poor { color: #ef4444; }
        
        .no-data {
            text-align: center;
            color: var(--text-secondary);
            font-style: italic;
            padding: 40px;
        }
        
        .loading {
            text-align: center;
            color: var(--text-secondary);
            padding: 40px;
        }
        
        @media (max-width: 768px) {
            .season-selector {
                flex-direction: column;
                gap: 15px;
            }
            
            .stats-table {
                font-size: 0.8rem;
            }
            
            .stats-table th,
            .stats-table td {
                padding: 8px;
            }
        }
    </style>
</head>
<body>
    <!-- Navigation Bar - Exact Material Design mat-toolbar -->
    <mat-toolbar class="mat-toolbar">
        <a href="/" class="nav-brand">PC '25</a>
        <div class="nav-links">
            <a href="/" class="nav-link">Dashboard</a>
            <a href="/analytics" class="nav-link active">Analytics</a>
        </div>
        <div class="flex-expand"></div>
        <div class="nav-controls">
            {{if .User}}
                <span class="user-info">{{.User.Name}}</span>
                <a href="/logout" class="logout-button">Logout</a>
            {{else}}
                <a href="/login" class="login-button">Login</a>
            {{end}}
            <button class="theme-toggle" id="theme-toggle">‚òÄÔ∏è</button>
        </div>
    </mat-toolbar>

    <!-- Mobile-only Return to Dashboard button -->
    <div class="mobile-return-button">
        <a href="/" class="return-button">‚Üê Return to Dashboard</a>
    </div>

    <div class="analytics-container">
        <!-- Header -->
        <div class="analytics-header">
            <h1>üìä NFL Analytics</h1>
            <p>Comprehensive statistics and performance analytics</p>
        </div>
        
        <!-- Season/Week Selector with HTMX -->
        <div class="season-selector">
            <div class="selector-group">
                <label for="season-select">Season</label>
                <select id="season-select" name="season" 
                        hx-get="/analytics" 
                        hx-target="#analytics-content"
                        hx-include="[name='week'], [name='all_seasons']"
                        hx-indicator="#loading-indicator">
                    {{range .Analytics.AvailableSeasons}}
                        <option value="{{.}}" {{if eq . $.Season}}selected{{end}}>{{.}}</option>
                    {{end}}
                </select>
            </div>
            
            <div class="selector-group">
                <label for="week-select">Week</label>
                <select id="week-select" name="week"
                        hx-get="/analytics"
                        hx-target="#analytics-content"
                        hx-include="[name='season'], [name='all_seasons']"
                        hx-indicator="#loading-indicator">
                    <option value="">All Weeks</option>
                    {{range seq 1 18}}
                        <option value="{{.}}" {{if and $.Week (eq . $.Week)}}selected{{end}}>Week {{.}}</option>
                    {{end}}
                </select>
            </div>
            
            <div class="selector-group">
                <label for="all-seasons-toggle">All Seasons</label>
                <input type="checkbox" id="all-seasons-toggle" name="all_seasons" value="true" 
                       {{if .Analytics.AllSeasons}}checked{{end}}
                       hx-get="/analytics"
                       hx-target="#analytics-content"
                       hx-include="[name='season'], [name='week']"
                       hx-indicator="#loading-indicator">
            </div>
            
            <div id="loading-indicator" class="htmx-indicator loading">
                <div>Loading...</div>
            </div>
        </div>

        <!-- Analytics Content (replaceable with HTMX) -->
        <div id="analytics-content">
            {{template "analytics-content" .}}
        </div>
    </div>

    <script>
        // Theme toggling
        document.addEventListener('DOMContentLoaded', function() {
            const themeToggle = document.getElementById('theme-toggle');
            const currentTheme = localStorage.getItem('theme') || 'dark';
            
            // Set initial theme icon
            themeToggle.textContent = currentTheme === 'dark' ? '‚òÄÔ∏è' : 'üåô';
            
            themeToggle.addEventListener('click', function() {
                const currentTheme = document.documentElement.getAttribute('data-theme') || 'dark';
                const newTheme = currentTheme === 'dark' ? 'light' : 'dark';
                
                document.documentElement.setAttribute('data-theme', newTheme);
                localStorage.setItem('theme', newTheme);
                themeToggle.textContent = newTheme === 'dark' ? '‚òÄÔ∏è' : 'üåô';
            });
            
            // Mobile swipe navigation for week/season traversal
            let touchStartX = 0;
            let touchStartY = 0;
            let touchEndX = 0;
            let touchEndY = 0;
            
            document.addEventListener('touchstart', function(event) {
                touchStartX = event.changedTouches[0].screenX;
                touchStartY = event.changedTouches[0].screenY;
            });
            
            document.addEventListener('touchend', function(event) {
                touchEndX = event.changedTouches[0].screenX;
                touchEndY = event.changedTouches[0].screenY;
                handleAnalyticsSwipe();
            });
            
            function handleAnalyticsSwipe() {
                const deltaX = touchEndX - touchStartX;
                const deltaY = touchEndY - touchStartY;
                const minSwipeDistance = 50;
                
                // Only process horizontal swipes that are longer than vertical swipes
                if (Math.abs(deltaX) > Math.abs(deltaY) && Math.abs(deltaX) > minSwipeDistance) {
                    const weekSelect = document.getElementById('week-select');
                    const seasonSelect = document.getElementById('season-select');
                    
                    if (!weekSelect || !seasonSelect) return;
                    
                    const currentWeek = weekSelect.value ? parseInt(weekSelect.value) : 0;
                    const currentSeason = parseInt(seasonSelect.value);
                    let newWeek = currentWeek;
                    let newSeason = currentSeason;
                    
                    if (deltaX > 0) {
                        // Swipe left-to-right: go to previous week
                        if (currentWeek > 1) {
                            newWeek = currentWeek - 1;
                        } else if (currentWeek === 1) {
                            // Go to "All Weeks" view of current season
                            newWeek = 0;
                        } else if (currentSeason > 2023) {
                            // Wrap to previous season, week 18
                            newWeek = 18;
                            newSeason = currentSeason - 1;
                        }
                    } else {
                        // Swipe right-to-left: go to next week
                        if (currentWeek === 0) {
                            // From "All Weeks" to Week 1
                            newWeek = 1;
                        } else if (currentWeek < 18) {
                            newWeek = currentWeek + 1;
                        } else if (currentSeason < 2025) {
                            // Wrap to next season, "All Weeks"
                            newWeek = 0;
                            newSeason = currentSeason + 1;
                        }
                    }
                    
                    if (newWeek !== currentWeek || newSeason !== currentSeason) {
                        // Update the form values
                        weekSelect.value = newWeek === 0 ? '' : newWeek;
                        seasonSelect.value = newSeason;
                        
                        // Trigger the HTMX change event on the season select (which includes week)
                        htmx.trigger(seasonSelect, 'change');
                    }
                }
            }
        });
    </script>
</body>
</html>

{{define "analytics-content"}}
<div class="analytics-grid">
    <!-- User Leaderboard -->
    <div class="analytics-section">
        <h2>üèÜ User Leaderboard</h2>
        {{if .Analytics.UserStats}}
            <table class="stats-table">
                <thead>
                    <tr>
                        <th>Rank</th>
                        <th>User</th>
                        <th>Total Score</th>
                        <th>ATS Record</th>
                        <th>ATS Win %</th>
                        <th>O/U Record</th>
                        <th>O/U Win %</th>
                        <th>Total Record</th>
                        <th>Total Win %</th>
                    </tr>
                </thead>
                <tbody>
                    {{range $i, $user := .Analytics.UserStats}}
                        <tr>
                            <td>{{add $i 1}}</td>
                            <td><strong>{{$user.UserName}}</strong></td>
                            <td><strong>{{$user.TotalScore}}</strong></td>
                            <td class="record">{{$user.ATSRecord.Wins}}-{{$user.ATSRecord.Losses}}-{{$user.ATSRecord.Pushes}}</td>
                            <td class="win-pct {{if gt $user.ATSRecord.WinPct 0.6}}good{{else if gt $user.ATSRecord.WinPct 0.45}}ok{{else}}poor{{end}}">
                                {{if gt $user.ATSRecord.Total 0}}{{printf "%.1f%%" (mul $user.ATSRecord.WinPct 100)}}{{else}}N/A{{end}}
                            </td>
                            <td class="record">{{$user.OURecord.Wins}}-{{$user.OURecord.Losses}}-{{$user.OURecord.Pushes}}</td>
                            <td class="win-pct {{if gt $user.OURecord.WinPct 0.6}}good{{else if gt $user.OURecord.WinPct 0.45}}ok{{else}}poor{{end}}">
                                {{if gt $user.OURecord.Total 0}}{{printf "%.1f%%" (mul $user.OURecord.WinPct 100)}}{{else}}N/A{{end}}
                            </td>
                            <td class="record">{{$user.TotalRecord.Wins}}-{{$user.TotalRecord.Losses}}-{{$user.TotalRecord.Pushes}}</td>
                            <td class="win-pct {{if gt $user.TotalRecord.WinPct 0.6}}good{{else if gt $user.TotalRecord.WinPct 0.45}}ok{{else}}poor{{end}}">
                                {{if gt $user.TotalRecord.Total 0}}{{printf "%.1f%%" (mul $user.TotalRecord.WinPct 100)}}{{else}}N/A{{end}}
                            </td>
                        </tr>
                    {{end}}
                </tbody>
            </table>
        {{else}}
            <div class="no-data">No user statistics available for the selected period.</div>
        {{end}}
    </div>

    <!-- Team Performance -->
    <div class="analytics-section">
        <h2>üèà Team Performance</h2>
        {{if .Analytics.TeamStats}}
            <table class="stats-table">
                <thead>
                    <tr>
                        <th>Team</th>
                        <th>SU Record</th>
                        <th>SU Win %</th>
                        <th>ATS Record</th>
                        <th>ATS Win %</th>
                        <th>O/U Record</th>
                        <th>O/U Win %</th>
                    </tr>
                </thead>
                <tbody>
                    {{range .Analytics.TeamStats}}
                        <tr>
                            <td><strong>{{.TeamAbbr}}</strong></td>
                            <td class="record">{{.SURecord.Wins}}-{{.SURecord.Losses}}-{{.SURecord.Pushes}}</td>
                            <td class="win-pct {{if gt .SURecord.WinPct 0.6}}good{{else if gt .SURecord.WinPct 0.45}}ok{{else}}poor{{end}}">
                                {{if gt .SURecord.Total 0}}{{printf "%.1f%%" (mul .SURecord.WinPct 100)}}{{else}}N/A{{end}}
                            </td>
                            <td class="record">{{.ATSRecord.Wins}}-{{.ATSRecord.Losses}}-{{.ATSRecord.Pushes}}</td>
                            <td class="win-pct {{if gt .ATSRecord.WinPct 0.6}}good{{else if gt .ATSRecord.WinPct 0.45}}ok{{else}}poor{{end}}">
                                {{if gt .ATSRecord.Total 0}}{{printf "%.1f%%" (mul .ATSRecord.WinPct 100)}}{{else}}N/A{{end}}
                            </td>
                            <td class="record">{{.OURecord.Wins}}-{{.OURecord.Losses}}-{{.OURecord.Pushes}}</td>
                            <td class="win-pct {{if gt .OURecord.WinPct 0.6}}good{{else if gt .OURecord.WinPct 0.45}}ok{{else}}poor{{end}}">
                                {{if gt .OURecord.Total 0}}{{printf "%.1f%%" (mul .OURecord.WinPct 100)}}{{else}}N/A{{end}}
                            </td>
                        </tr>
                    {{end}}
                </tbody>
            </table>
        {{else}}
            <div class="no-data">No team statistics available for the selected period.</div>
        {{end}}
    </div>

    <!-- League Statistics -->
    <div class="analytics-section">
        <h2>üèüÔ∏è League Statistics</h2>
        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 20px;">
            <div>
                <h3>Betting Trends</h3>
                <table class="stats-table">
                    <tr>
                        <td>Favorites ATS</td>
                        <td class="record">{{.Analytics.LeagueStats.FavoredATS.Wins}}-{{.Analytics.LeagueStats.FavoredATS.Losses}}-{{.Analytics.LeagueStats.FavoredATS.Pushes}}</td>
                        <td class="win-pct">{{if gt .Analytics.LeagueStats.FavoredATS.Total 0}}{{printf "%.1f%%" (mul .Analytics.LeagueStats.FavoredATS.WinPct 100)}}{{else}}N/A{{end}}</td>
                    </tr>
                    <tr>
                        <td>Home Teams ATS</td>
                        <td class="record">{{.Analytics.LeagueStats.HomeATS.Wins}}-{{.Analytics.LeagueStats.HomeATS.Losses}}-{{.Analytics.LeagueStats.HomeATS.Pushes}}</td>
                        <td class="win-pct">{{if gt .Analytics.LeagueStats.HomeATS.Total 0}}{{printf "%.1f%%" (mul .Analytics.LeagueStats.HomeATS.WinPct 100)}}{{else}}N/A{{end}}</td>
                    </tr>
                    <tr>
                        <td>Over/Under</td>
                        <td class="record">{{.Analytics.LeagueStats.OverUnder.Wins}}-{{.Analytics.LeagueStats.OverUnder.Losses}}-{{.Analytics.LeagueStats.OverUnder.Pushes}}</td>
                        <td class="win-pct">{{if gt .Analytics.LeagueStats.OverUnder.Total 0}}{{printf "%.1f%%" (mul .Analytics.LeagueStats.OverUnder.WinPct 100)}}{{else}}N/A{{end}}</td>
                    </tr>
                </table>
            </div>
            
            <div>
                <h3>Upsets & Extremes</h3>
                <table class="stats-table">
                    <tr>
                        <td>Upsets (5+ pt spreads)</td>
                        <td class="record">{{.Analytics.LeagueStats.UpsetSU.Wins}}-{{.Analytics.LeagueStats.UpsetSU.Losses}}-{{.Analytics.LeagueStats.UpsetSU.Pushes}}</td>
                        <td class="win-pct">{{if gt .Analytics.LeagueStats.UpsetSU.Total 0}}{{printf "%.1f%%" (mul .Analytics.LeagueStats.UpsetSU.WinPct 100)}}{{else}}N/A{{end}}</td>
                    </tr>
                    <tr>
                        <td>High Totals (50+)</td>
                        <td class="record">{{.Analytics.LeagueStats.ExtremeOVR.Wins}}-{{.Analytics.LeagueStats.ExtremeOVR.Losses}}-{{.Analytics.LeagueStats.ExtremeOVR.Pushes}}</td>
                        <td class="win-pct">{{if gt .Analytics.LeagueStats.ExtremeOVR.Total 0}}{{printf "%.1f%%" (mul .Analytics.LeagueStats.ExtremeOVR.WinPct 100)}}{{else}}N/A{{end}}</td>
                    </tr>
                    <tr>
                        <td>Low Totals (40-)</td>
                        <td class="record">{{.Analytics.LeagueStats.ExtremeUND.Wins}}-{{.Analytics.LeagueStats.ExtremeUND.Losses}}-{{.Analytics.LeagueStats.ExtremeUND.Pushes}}</td>
                        <td class="win-pct">{{if gt .Analytics.LeagueStats.ExtremeUND.Total 0}}{{printf "%.1f%%" (mul .Analytics.LeagueStats.ExtremeUND.WinPct 100)}}{{else}}N/A{{end}}</td>
                    </tr>
                </table>
            </div>
        </div>
    </div>
</div>
{{end}}