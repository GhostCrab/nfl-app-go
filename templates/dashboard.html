<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{{.Title}}</title>
    <script>
        // Apply dark theme by default to match legacy
        (function() {
            const savedTheme = localStorage.getItem('theme') || 'dark';
            if (savedTheme === 'light') {
                document.documentElement.setAttribute('data-theme', 'light');
            }
        })();
    </script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@300;400;500;700&display=block" rel="stylesheet">
    <script src="https://unpkg.com/htmx.org@1.9.10"></script>
    <script src="https://unpkg.com/htmx.org@1.9.10/dist/ext/sse.js"></script>
    <link rel="stylesheet" href="/static/style.css">
</head>
<body>
    <!-- Navigation Bar - Exact Material Design mat-toolbar -->
    <mat-toolbar class="mat-toolbar">
        <a href="/" class="nav-brand">PC '25</a>
        <div class="nav-links">
            <a href="/" class="nav-link active">Dashboard</a>
            <a href="/analytics" class="nav-link">Statistics</a>
            <a href="/survivor" class="nav-link">Survivor</a>
        </div>
        <div class="flex-expand"></div>
        <div class="nav-controls">
            {{if .User}}
                <span class="user-info">{{.User.Name}}</span>
                <a href="/logout" class="logout-button">Logout</a>
            {{else}}
                <a href="/login" class="login-button">Login</a>
            {{end}}
            <button class="theme-toggle" onclick="toggleTheme()">☀️</button>
        </div>
    </mat-toolbar>

    <!-- Dashboard Container - Exact legacy three-column layout -->
    <div class="dashboard-container">
        <div class="dashboard-content">
            <!-- Left Column: Pick Lists - Material Design Structure -->
            <div class="pick-flex-item">
                <!-- Unified rendering for all users (current user first, then others) -->
                {{if .UserPicks}}
                    {{$currentUserName := ""}}
                    {{if .User}}{{$currentUserName = .User.Name}}{{end}}
                    
                    <!-- Render current user first if logged in -->
                    {{if .User}}
                        {{range .UserPicks}}
                            {{if eq .UserName $currentUserName}}
                                <fieldset class="user-picks-section">
                                    <legend>MY PICKS</legend>
                                    <div class="user-picks-content">

                                    <!-- Bonus Thursday picks -->
                                    {{if .BonusThursdayPicks}}
                                        <div class="regular-picks-section">
                                            <div class="picks-category-header">BONUS THURSDAY</div>
                                            <div class="picks-list">
                                                {{range .BonusThursdayPicks}}
                                                    <div class="pick-item {{.GetResultClass}}">
                                                        <span class="pick-info">{{if .PickDescription}}{{.PickDescription}}{{else}}Game {{.GameID}} - Team {{.TeamID}} ({{.PickType}}){{end}}</span>
                                                        <span class="pick-result">{{.Result}}</span>
                                                    </div>
                                                {{end}}
                                            </div>
                                        </div>
                                    {{end}}

                                    <!-- Bonus Friday picks -->
                                    {{if .BonusFridayPicks}}
                                        <div class="regular-picks-section">
                                            <div class="picks-category-header">BONUS FRIDAY</div>
                                            <div class="picks-list">
                                                {{range .BonusFridayPicks}}
                                                    <div class="pick-item {{.GetResultClass}}">
                                                        <span class="pick-info">{{if .PickDescription}}{{.PickDescription}}{{else}}Game {{.GameID}} - Team {{.TeamID}} ({{.PickType}}){{end}}</span>
                                                        <span class="pick-result">{{.Result}}</span>
                                                    </div>
                                                {{end}}
                                            </div>
                                        </div>
                                    {{end}}

                                    <!-- Remaining picks (filtered to exclude bonus picks) -->
                                    {{if .Picks}}
                                        {{$hasAnyBonusPicks := or .BonusThursdayPicks .BonusFridayPicks}}
                                        {{if $hasAnyBonusPicks}}
                                            <div class="regular-picks-section">
                                                <div class="picks-category-header">REMAINING PICKS</div>
                                                <div class="picks-list">
                                                    {{$userPicks := .}}
                                                    {{range .Picks}}
                                                        {{$currentPick := .}}
                                                        {{$isBonus := false}}
                                                        {{range $userPicks.BonusThursdayPicks}}{{if eq .GameID $currentPick.GameID}}{{$isBonus = true}}{{end}}{{end}}
                                                        {{range $userPicks.BonusFridayPicks}}{{if eq .GameID $currentPick.GameID}}{{$isBonus = true}}{{end}}{{end}}
                                                        {{if not $isBonus}}
                                                        <div class="pick-item {{.GetResultClass}}">
                                                            <span class="pick-info">{{if .PickDescription}}{{.PickDescription}}{{else}}Game {{.GameID}} - Team {{.TeamID}} ({{.PickType}}){{end}}</span>
                                                            <span class="pick-result">{{.Result}}</span>
                                                        </div>
                                                        {{end}}
                                                    {{end}}
                                                </div>
                                            </div>
                                        {{else}}
                                            <!-- No bonus picks - use same container structure but no header -->
                                            <div class="picks-list">
                                                {{range .Picks}}
                                                    <div class="pick-item {{.GetResultClass}}">
                                                        <span class="pick-info">{{if .PickDescription}}{{.PickDescription}}{{else}}Game {{.GameID}} - Team {{.TeamID}} ({{.PickType}}){{end}}</span>
                                                        <span class="pick-result">{{.Result}}</span>
                                                    </div>
                                                {{end}}
                                            </div>
                                        {{end}}
                                    {{else}}
                                        <div class="no-picks">No picks yet for this week</div>
                                    {{end}}
                                    </div>
                                </fieldset>
                            {{end}}
                        {{end}}
                    {{else}}
                        <!-- Not logged in - show historical picks overview -->
                        <fieldset class="user-picks-section mt-4">
                            <legend>Historical Picks Available</legend>
                            <div class="user-picks-content">
                                <div class="historical-picks-info">
                                    <p>Historical picks are available for this week.</p>
                                    <p>Log in to see detailed pick information.</p>
                                    <p>{{len .UserPicks}} users made picks this week.</p>
                                </div>
                            </div>
                        </fieldset>
                    {{end}}

                    <!-- Render all other users -->
                    {{range .UserPicks}}
                        {{if ne .UserName $currentUserName}}
                            <fieldset class="user-picks-section mt-4">
                                <legend>{{.UserName}}'S PICKS</legend>
                                <div class="user-picks-content">

                                <!-- Bonus Thursday picks -->
                                {{if .BonusThursdayPicks}}
                                    <div class="regular-picks-section">
                                        <div class="picks-category-header">BONUS THURSDAY</div>
                                        <div class="picks-list">
                                            {{range .BonusThursdayPicks}}
                                                <div class="pick-item {{.GetResultClass}}">
                                                    <span class="pick-info">{{if .PickDescription}}{{.PickDescription}}{{else}}Game {{.GameID}} - Team {{.TeamID}} ({{.PickType}}){{end}}</span>
                                                    <span class="pick-result">{{.Result}}</span>
                                                </div>
                                            {{end}}
                                        </div>
                                    </div>
                                {{end}}

                                <!-- Bonus Friday picks -->
                                {{if .BonusFridayPicks}}
                                    <div class="regular-picks-section">
                                        <div class="picks-category-header">BONUS FRIDAY</div>
                                        <div class="picks-list">
                                            {{range .BonusFridayPicks}}
                                                <div class="pick-item {{.GetResultClass}}">
                                                    <span class="pick-info">{{if .PickDescription}}{{.PickDescription}}{{else}}Game {{.GameID}} - Team {{.TeamID}} ({{.PickType}}){{end}}</span>
                                                    <span class="pick-result">{{.Result}}</span>
                                                </div>
                                            {{end}}
                                        </div>
                                    </div>
                                {{end}}

                                <!-- Remaining picks (filtered to exclude bonus picks) -->
                                {{if .Picks}}
                                    {{$hasAnyBonusPicks := or .BonusThursdayPicks .BonusFridayPicks}}
                                    {{if $hasAnyBonusPicks}}
                                        <div class="regular-picks-section">
                                            <div class="picks-category-header">REMAINING PICKS</div>
                                            <div class="picks-list">
                                                {{$userPicks := .}}
                                                {{range .Picks}}
                                                    {{$currentPick := .}}
                                                    {{$isBonus := false}}
                                                    {{range $userPicks.BonusThursdayPicks}}{{if eq .GameID $currentPick.GameID}}{{$isBonus = true}}{{end}}{{end}}
                                                    {{range $userPicks.BonusFridayPicks}}{{if eq .GameID $currentPick.GameID}}{{$isBonus = true}}{{end}}{{end}}
                                                    {{if not $isBonus}}
                                                    <div class="pick-item {{.GetResultClass}}">
                                                        <span class="pick-info">{{if .PickDescription}}{{.PickDescription}}{{else}}Game {{.GameID}} - Team {{.TeamID}} ({{.PickType}}){{end}}</span>
                                                        <span class="pick-result">{{.Result}}</span>
                                                    </div>
                                                    {{end}}
                                                {{end}}
                                            </div>
                                        </div>
                                    {{else}}
                                        <!-- No bonus picks - use same container structure but no header -->
                                        <div class="picks-list">
                                            {{range .Picks}}
                                                <div class="pick-item {{.GetResultClass}}">
                                                    <span class="pick-info">{{if .PickDescription}}{{.PickDescription}}{{else}}Game {{.GameID}} - Team {{.TeamID}} ({{.PickType}}){{end}}</span>
                                                    <span class="pick-result">{{.Result}}</span>
                                                </div>
                                            {{end}}
                                        </div>
                                    {{end}}
                                {{else}}
                                    <div class="no-picks">No picks for this week</div>
                                {{end}}
                                </div>
                            </fieldset>
                        {{end}}
                    {{end}}
                {{else}}
                    <!-- No picks data available -->
                    <fieldset class="user-picks-section mt-4">
                        <legend>My Picks</legend>
                        <div class="user-picks-content">
                            <div class="no-picks">Please log in to see picks</div>
                        </div>
                    </fieldset>
                {{end}}
            </div>

            <!-- Center Column: Current Games - Material Design Structure -->
            <div class="game-flex-item">
                <!-- Week Selector with mat-form-field structure -->
                <div class="week-selector-container">
                    <div class="form-field">
                        <label for="week-select" class="form-label">View Week</label>
                        <select id="week-select" class="week-select" onchange="selectWeek(this.value)">
                            {{range .Weeks}}
                                <option value="{{.}}" {{if eq . $.CurrentWeek}}selected{{end}}>
                                    Week {{.}}
                                </option>
                            {{end}}
                        </select>
                    </div>
                    <span class="keyboard-hint">
                        Use ← → arrow keys to navigate
                    </span>
                    {{if .User}}
                        <button class="update-picks-btn" onclick="window.location.href='/picker'">
                            Update Picks
                        </button>
                    {{end}}
                </div>

                <!-- Games Grid with mat-grid-list structure -->
                <div class="games-container" hx-ext="sse" sse-connect="/events">
                    <div class="section-header" id="games-header">CURRENT GAMES</div>
                    <div class="games-grid">
                        {{template "game-grid" .}}
                    </div>
                </div>
            </div>

            <!-- Right Column: Club Scores - Material Design Structure -->
            <div class="score-flex-item">
                <div class="section-header">CLUB SCORE</div>
                <div class="club-scores">
                    {{if .UserPicks}}
                        {{range .UserPicks}}
                            <div class="score-item">
                                <span class="user-name">{{.UserName}}</span>
                                <span class="user-score">{{.Record.String}}</span>
                            </div>
                        {{end}}
                    {{else}}
                        {{range .Users}}
                            <div class="score-item">
                                <span class="user-name">{{.Name}}</span>
                                <span class="user-score">0-0-0</span>
                            </div>
                        {{end}}
                    {{end}}
                </div>

                <!-- Week Summary -->
                <div class="week-summary mt-4">
                    <div class="section-header">Week Summary</div>
                    <div class="summary-stats">
                        <div class="stat-item">
                            <span>Games Played:</span>
                            <span>{{len .Games}}</span>
                        </div>
                        <div class="stat-item">
                            <span>Games Remaining:</span>
                            <span id="games-remaining">0</span>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Template for game grid that will be updated via SSE - Mat Grid Tile Structure -->
    {{define "game-grid"}}
        <mat-grid-list class="mat-grid-list" cols="21" sse-swap="gameUpdate">
            {{range .Games}}
                <mat-grid-tile class="game-card {{.State}}" id="game-{{.ID}}" colspan="21" rowspan="1">
                    <!-- Away Team - colspan equivalent for flex layout -->
                    <div class="team-section away" style="flex: 5;">
                        <div class="team-name">
                            <img class="team-img" src="{{.GetAwayTeamIconURL}}" alt="{{.Away}}" 
                                 onerror="this.style.display='none'"/>
                            <div>
                                <div>{{.Away}}</div>
                                {{if .HasOdds}}
                                    <div class="team-spread">{{.FormatAwaySpread}}</div>
                                {{end}}
                            </div>
                            {{if ne .State "scheduled"}}
                                <span class="score-display">{{.AwayScore}}</span>
                            {{end}}
                        </div>
                    </div>

                    <!-- VS Separator - colspan equivalent -->
                    <div class="vs-separator" style="flex: 2;">@</div>

                    <!-- Home Team - colspan equivalent -->
                    <div class="team-section home" style="flex: 5;">
                        <div class="team-name">
                            {{if ne .State "scheduled"}}
                                <span class="score-display">{{.HomeScore}}</span>
                            {{end}}
                            <img class="team-img" src="{{.GetHomeTeamIconURL}}" alt="{{.Home}}" 
                                 onerror="this.style.display='none'"/>
                            <div>
                                <div>{{.Home}}</div>
                                {{if .HasOdds}}
                                    <div class="team-spread">{{.FormatHomeSpread}}</div>
                                {{end}}
                            </div>
                        </div>
                    </div>

                    <!-- Over/Under - colspan equivalent -->
                    <div class="ou-section" style="flex: 3;">
                        {{if .HasOdds}}
                            O/U {{.Odds.OU}}
                        {{else}}
                            -
                        {{end}}
                    </div>

                    <!-- Game Status - colspan equivalent -->
                    <div class="game-status-section" style="flex: 6;">
                        {{if eq .State "scheduled"}}
                            <div class="game-week">Week {{.Week}}</div>
                            <div class="game-time">{{.FormatGameTime}}</div>
                        {{else if eq .State "in_play"}}
                            <div class="live-indicator">LIVE</div>
                            <div class="game-time">Q{{.Quarter}}</div>
                        {{else if eq .State "completed"}}
                            <div class="game-time">FINAL</div>
                            {{if and .HasOdds .IsCompleted}}
                                <div class="spread-result">
                                    {{if eq .SpreadResult "push"}}
                                        PUSH
                                    {{else if eq .SpreadResult "home-covered"}}
                                        {{.Home}} ✓
                                    {{else if eq .SpreadResult "away-covered"}}
                                        {{.Away}} ✓
                                    {{end}}
                                </div>
                            {{end}}
                        {{end}}
                    </div>
                </mat-grid-tile>
            {{end}}
        </mat-grid-list>
    {{end}}

    <script>
        function toggleTheme() {
            const html = document.documentElement;
            const button = document.querySelector('.theme-toggle');
            
            if (html.getAttribute('data-theme') === 'light') {
                html.removeAttribute('data-theme');
                button.textContent = '☀️';
                localStorage.setItem('theme', 'dark');
            } else {
                html.setAttribute('data-theme', 'light');
                button.textContent = '🌙';
                localStorage.setItem('theme', 'light');
            }
        }

        async function selectWeek(week) {
            // Use the same fast AJAX navigation logic as keyboard navigation
            const newWeek = parseInt(week);
            const newSeason = currentDisplayedSeason; // Keep current season
            
            if (newWeek !== currentDisplayedWeek) {
                // Load data using the same method as keyboard navigation
                let data = null;
                
                // Check cache first
                if (!seasonCache[newSeason]) seasonCache[newSeason] = {};
                data = seasonCache[newSeason][newWeek];
                
                if (!data && !isLoading) {
                    // Load from server
                    data = await loadDashboardData(newWeek, newSeason);
                    if (data && typeof data === 'object' && data.userPicks) {
                        console.log(`Caching data for ${newSeason} Week ${newWeek} from dropdown`);
                        seasonCache[newSeason][newWeek] = data;
                    }
                }
                
                if (data) {
                    console.log(`Updating display from dropdown to week ${newWeek}`);
                    updateDashboardDisplay(data);
                }
            }
        }

        // Navigation variables with caching
        let currentDisplayedWeek = {{.CurrentWeek}};
        let currentDisplayedSeason = {{.CurrentSeason}}; // Use server-provided season
        const MIN_SEASON = 2023;
        const MAX_SEASON = 2025;
        
        // Cache for storing game data by season and week
        let seasonCache = {};
        let isLoading = false;
        

        // Fast AJAX navigation for arrow keys - loads complete dashboard data
        async function loadDashboardData(week, season) {
            console.log('loadDashboardData called with week:', week, 'season:', season);
            if (isLoading) return null;
            
            const url = `/api/dashboard?week=${week}&season=${season}`;
            
            try {
                isLoading = true;
                const response = await fetch(url);
                if (!response.ok) throw new Error(`HTTP ${response.status}`);
                const data = await response.json();
                console.log('loadDashboardData received data for week:', data?.currentWeek, 'season:', data?.season);
                return data;
            } catch (error) {
                console.error('Failed to load dashboard data:', error);
                return null;
            } finally {
                isLoading = false;
            }
        }

        // Update the dashboard display with new data
        async function updateDashboardDisplay(data) {
            console.log('updateDashboardDisplay called with week:', data?.currentWeek, 'season:', data?.season);
            if (!data) {
                console.warn('No data provided to updateDashboardDisplay');
                return;
            }
            
            // Check if data is HTML string instead of JSON object
            if (typeof data === 'string') {
                console.error('ERROR: updateDashboardDisplay received HTML string instead of JSON object:', data.substring(0, 200));
                console.error('Stack trace:', new Error().stack);
                return;
            }
            
            console.log('updateDashboardDisplay received data:', data);
            const { games, userPicks, user, currentWeek: week, season } = data;
            console.log('Extracted userPicks:', userPicks);
            console.log('Extracted user:', user);
            
            // Update games grid using the existing games API (it's fast)
            await updateGamesGrid(week, season);
            
            // Update picks display with client-side rendering
            updatePicksDisplay(userPicks, user);
            
            // Update other players' picks display
            updateOtherPlayersDisplay(userPicks, user);
            
            // Update header
            const gamesHeader = document.getElementById('games-header');
            if (gamesHeader) {
                if (season === 2025) {
                    gamesHeader.textContent = `Week ${week} Games`;
                } else {
                    gamesHeader.textContent = `Week ${week} Games (${season})`;
                }
            }
            
            // Update URL without reload
            const url = new URL(window.location);
            url.searchParams.set('week', week);
            if (season !== 2025) {
                url.searchParams.set('season', season);
            } else {
                url.searchParams.delete('season');
            }
            history.pushState({week, season}, '', url.toString());
            
            // Update current displayed values
            currentDisplayedWeek = week;
            currentDisplayedSeason = season;
            
            // Update dropdown selection
            const weekSelect = document.getElementById('week-select');
            if (weekSelect) {
                weekSelect.value = week;
            }
        }

        // Update games grid using existing games API
        async function updateGamesGrid(week, season) {
            try {
                const response = await fetch(`/api/games?week=${week}&season=${season}`);
                if (response.ok) {
                    const html = await response.text();
                    const gamesGrid = document.querySelector('.games-grid');
                    if (gamesGrid) {
                        gamesGrid.innerHTML = html;
                    }
                }
            } catch (error) {
                console.error('Failed to update games grid:', error);
            }
        }

        // Helper function to map pick results to CSS classes (matches Go GetResultClass method)
        function getPickResultClass(result) {
            switch (result) {
                case 'win':
                    return 'green-pick-class';
                case 'loss':
                    return 'red-pick-class';
                case 'push':
                    return 'yellow-pick-class';
                default: // pending or any other state
                    return 'pick-class';
            }
        }

        // Helper function to format parlay score (matches Go UserRecord.String() method)
        function formatParlayScore(record) {
            if (!record) return '0';
            
            // Use parlay points if available, otherwise fallback to W-L format
            if (record.parlay_points !== undefined) {
                if (record.weekly_points && record.weekly_points > 0) {
                    return `${record.parlay_points} (+${record.weekly_points})`;
                }
                return `${record.parlay_points}`;
            }
            
            // Fallback to legacy W-L-P format
            return `${record.wins || 0}-${record.losses || 0}-${record.pushes || 0}`;
        }


        // Filter out bonus picks from regular picks
        function filterRegularPicks(allPicks, bonusThursdayPicks, bonusFridayPicks) {
            if (!allPicks || !Array.isArray(allPicks)) return [];
            
            const bonusGameIds = new Set();
            
            // Add bonus Thursday game IDs
            if (bonusThursdayPicks && Array.isArray(bonusThursdayPicks)) {
                bonusThursdayPicks.forEach(pick => bonusGameIds.add(pick.game_id));
            }
            
            // Add bonus Friday game IDs
            if (bonusFridayPicks && Array.isArray(bonusFridayPicks)) {
                bonusFridayPicks.forEach(pick => bonusGameIds.add(pick.game_id));
            }
            
            // Return picks that are not in bonus games
            return allPicks.filter(pick => !bonusGameIds.has(pick.game_id));
        }

        // Unified function to create any user's picks section (current user or others)
        function createUnifiedUserPicksSection(userPicksData, isCurrentUser = false) {
            const section = document.createElement('fieldset');
            section.className = isCurrentUser ? 'user-picks-section' : 'user-picks-section mt-4';
            
            const legend = document.createElement('legend');
            legend.textContent = isCurrentUser ? 'MY PICKS' : `${userPicksData.user_name || 'Unknown'}'S PICKS`;
            section.appendChild(legend);
            
            const content = document.createElement('div');
            content.className = 'user-picks-content';
            
            // Add bonus Thursday picks if they exist
            if (userPicksData.bonus_thursday_picks && userPicksData.bonus_thursday_picks.length > 0) {
                const bonusSection = createRegularPicksSection('BONUS THURSDAY', userPicksData.bonus_thursday_picks);
                content.appendChild(bonusSection);
            }
            
            // Add bonus Friday picks if they exist  
            if (userPicksData.bonus_friday_picks && userPicksData.bonus_friday_picks.length > 0) {
                const bonusSection = createRegularPicksSection('BONUS FRIDAY', userPicksData.bonus_friday_picks);
                content.appendChild(bonusSection);
            }
            
            // Add regular picks if they exist
            if (userPicksData.picks && userPicksData.picks.length > 0) {
                const hasAnyBonusPicks = (userPicksData.bonus_thursday_picks && userPicksData.bonus_thursday_picks.length > 0) ||
                                       (userPicksData.bonus_friday_picks && userPicksData.bonus_friday_picks.length > 0);
                
                if (hasAnyBonusPicks) {
                    // Has bonus picks - show "REMAINING PICKS" header with filtered picks
                    const regularPicks = filterRegularPicks(
                        userPicksData.picks, 
                        userPicksData.bonus_thursday_picks, 
                        userPicksData.bonus_friday_picks
                    );
                    const regularSection = createRegularPicksSection('REMAINING PICKS', regularPicks);
                    content.appendChild(regularSection);
                } else {
                    // No bonus picks - use same container structure but no header
                    const picksList = document.createElement('div');
                    picksList.className = 'picks-list';
                    
                    userPicksData.picks.forEach(pick => {
                        const pickItem = createPickItem(pick);
                        picksList.appendChild(pickItem);
                    });
                    
                    content.appendChild(picksList);
                }
            } else {
                const noPicks = document.createElement('div');
                noPicks.className = 'no-picks';
                noPicks.textContent = isCurrentUser ? 'No picks yet for this week' : 'No picks for this week';
                content.appendChild(noPicks);
            }
            
            section.appendChild(content);
            return section;
        }
        
        // Update other players' detailed picks display using unified rendering
        function updateOtherPlayersDisplay(userPicks, currentUser) {
            if (!userPicks || !Array.isArray(userPicks)) {
                console.warn('No valid userPicks data for other players');
                return;
            }
            
            // Find the container for other players (everything after current user's picks)
            const pickFlexItem = document.querySelector('.pick-flex-item');
            if (!pickFlexItem) {
                console.warn('Pick flex item not found');
                return;
            }
            
            // Remove existing other player sections (but keep current user section which is first)
            const allSections = pickFlexItem.querySelectorAll('.user-picks-section');
            // Remove all sections except the first one (current user)
            for (let i = 1; i < allSections.length; i++) {
                allSections[i].remove();
            }
            
            // Add other players' sections using unified rendering
            userPicks.forEach(up => {
                if (!currentUser || up.user_id !== currentUser.id) {
                    const userSection = createUnifiedUserPicksSection(up, false);
                    pickFlexItem.appendChild(userSection);
                }
            });
        }
        
        // Create regular picks section
        function createRegularPicksSection(title, picks) {
            const section = document.createElement('div');
            section.className = 'regular-picks-section';
            
            const categoryHeader = document.createElement('div');
            categoryHeader.className = 'picks-category-header';
            categoryHeader.textContent = title;
            section.appendChild(categoryHeader);
            
            const picksList = document.createElement('div');
            picksList.className = 'picks-list';
            
            picks.forEach(pick => {
                const pickItem = createPickItem(pick);
                picksList.appendChild(pickItem);
            });
            
            section.appendChild(picksList);
            return section;
        }

        
        // Create individual pick item
        function createPickItem(pick) {
            const pickItem = document.createElement('div');
            pickItem.className = `pick-item ${getPickResultClass(pick.result)}`;
            
            const pickInfo = document.createElement('span');
            pickInfo.className = 'pick-info';
            pickInfo.textContent = pick.pick_description || `Game ${pick.game_id} - Team ${pick.team_id} (${pick.pick_type})`;
            
            const pickResult = document.createElement('span');
            pickResult.className = 'pick-result';
            pickResult.textContent = pick.result || 'pending';
            
            pickItem.appendChild(pickInfo);
            pickItem.appendChild(pickResult);
            
            return pickItem;
        }

        // Update current user's picks display using unified rendering
        function updatePicksDisplay(userPicks, currentUser) {
            console.log('Updating picks display:', { userPicks, currentUser });
            
            // Check if userPicks is valid
            if (!userPicks || !Array.isArray(userPicks)) {
                console.warn('Invalid userPicks data:', userPicks);
                userPicks = []; // Default to empty array
            }
            
            // Find the current user's fieldset (first one)
            const currentUserFieldset = document.querySelector('.user-picks-section');
            if (!currentUserFieldset) {
                console.warn('Current user fieldset not found');
                return;
            }
            
            // Update current user's picks using unified rendering
            if (currentUser) {
                console.log('Looking for current user ID:', currentUser.id);
                console.log('Available user IDs in userPicks:');
                userPicks.forEach(up => console.log(`  - user_id: ${up.user_id}, user_name: ${up.user_name}`));
                const currentUserPicks = userPicks.find(up => up.user_id === currentUser.id);
                console.log('Current user picks:', currentUserPicks);
                
                if (currentUserPicks) {
                    // Replace the entire current user section with unified rendering
                    const newCurrentUserSection = createUnifiedUserPicksSection(currentUserPicks, true);
                    currentUserFieldset.parentNode.replaceChild(newCurrentUserSection, currentUserFieldset);
                } else {
                    // No picks found for current user
                    const content = currentUserFieldset.querySelector('.user-picks-content');
                    if (content) {
                        content.innerHTML = '<div class="no-picks">No picks yet for this week</div>';
                    }
                }
            } else {
                console.log('No current user, showing generic message');
                const content = currentUserFieldset.querySelector('.user-picks-content');
                if (content) {
                    if (userPicks && userPicks.length > 0) {
                        content.innerHTML = `
                            <div class="historical-picks-info">
                                <p>Historical picks are available for this week.</p>
                                <p>Log in to see detailed pick information.</p>
                                <p>${userPicks.length} users made picks this week.</p>
                            </div>
                        `;
                    } else {
                        content.innerHTML = '<div class="no-picks">Please log in to see picks</div>';
                    }
                }
            }

            // Update other users list
            const otherPicksSection = document.querySelector('.other-picks-section .user-picks-item');
            if (otherPicksSection && otherPicksSection.parentElement) {
                const container = otherPicksSection.parentElement;
                // Clear existing users except header
                const existingItems = container.querySelectorAll('.user-picks-item');
                existingItems.forEach(item => item.remove());
                
                // Add updated user list
                userPicks.forEach(up => {
                    if (!currentUser || up.user_id !== currentUser.id) {
                        const userItem = document.createElement('div');
                        userItem.className = 'user-picks-item';
                        userItem.innerHTML = `
                            <div class="user-name">${up.user_name}</div>
                            <div class="user-record">${formatParlayScore(up.record)}</div>
                        `;
                        container.appendChild(userItem);
                    }
                });
            }

            // Update club scores
            const clubScores = document.querySelector('.club-scores');
            if (clubScores && userPicks && Array.isArray(userPicks)) {
                clubScores.innerHTML = userPicks.map(up => 
                    `<div class="score-item">
                        <span class="user-name">${up.user_name || 'Unknown'}</span>
                        <span class="user-score">${formatParlayScore(up.record)}</span>
                    </div>`
                ).join('');
            }
        }

        // Fast keyboard navigation with AJAX caching
        async function handleKeyboardNavigation(event) {
            // Only handle arrow keys when not typing in an input field
            if (event.target.tagName === 'INPUT' || event.target.tagName === 'TEXTAREA' || isLoading) {
                return;
            }
            
            let newWeek = currentDisplayedWeek;
            let newSeason = currentDisplayedSeason;
            
            if (event.key === 'ArrowLeft') {
                if (currentDisplayedWeek > 1) {
                    newWeek = currentDisplayedWeek - 1;
                } else if (currentDisplayedSeason > MIN_SEASON) {
                    newWeek = 18;
                    newSeason = currentDisplayedSeason - 1;
                }
            } else if (event.key === 'ArrowRight') {
                if (currentDisplayedWeek < 18) {
                    newWeek = currentDisplayedWeek + 1;
                } else if (currentDisplayedSeason < MAX_SEASON) {
                    newWeek = 1;
                    newSeason = currentDisplayedSeason + 1;
                }
            } else {
                return; // Not an arrow key
            }
            
            if (newWeek !== currentDisplayedWeek || newSeason !== currentDisplayedSeason) {
                event.preventDefault();
                
                // Check cache first
                if (!seasonCache[newSeason]) seasonCache[newSeason] = {};
                
                let data = seasonCache[newSeason][newWeek];
                
                if (!data) {
                    // Load from server
                    data = await loadDashboardData(newWeek, newSeason);
                    if (data && typeof data === 'object' && data.userPicks) {
                        console.log(`Caching data for ${newSeason} Week ${newWeek}, type:`, typeof data);
                        seasonCache[newSeason][newWeek] = data;
                    } else {
                        console.warn(`Not caching invalid data for ${newSeason} Week ${newWeek}, type:`, typeof data);
                    }
                } else {
                    console.log(`Using cached data for ${newSeason} Week ${newWeek}, type:`, typeof data);
                }
                
                if (data) {
                    console.log(`About to call updateDashboardDisplay with data type:`, typeof data);
                    updateDashboardDisplay(data);
                }
            }
        }

        // Initialize theme button and keyboard navigation
        document.addEventListener('DOMContentLoaded', function() {
            
            const savedTheme = localStorage.getItem('theme') || 'dark';
            const button = document.querySelector('.theme-toggle');
            
            if (savedTheme === 'light') {
                button.textContent = '🌙';
            }

            // Update games remaining counter
            const scheduledGames = document.querySelectorAll('.game-card.scheduled').length;
            const gamesRemainingEl = document.getElementById('games-remaining');
            if (gamesRemainingEl) {
                gamesRemainingEl.textContent = scheduledGames;
            }

            // Initialize the games header on page load
            const gamesHeader = document.getElementById('games-header');
            if (gamesHeader) {
                if (currentDisplayedSeason === 2025) {
                    gamesHeader.textContent = `Week ${currentDisplayedWeek} Games`;
                } else {
                    gamesHeader.textContent = `Week ${currentDisplayedWeek} Games (${currentDisplayedSeason})`;
                }
            }

            // Add keyboard navigation listener
            document.addEventListener('keydown', handleKeyboardNavigation);
            
            // Note: Caching is now handled by the JSON-based dashboard API system
            
            // Preload adjacent weeks in background for faster navigation
            setTimeout(() => {
                // Preload previous week
                let prevWeek = currentDisplayedWeek - 1;
                let prevSeason = currentDisplayedSeason;
                if (prevWeek < 1 && currentDisplayedSeason > MIN_SEASON) {
                    prevWeek = 18;
                    prevSeason = currentDisplayedSeason - 1;
                }
                if (prevWeek >= 1 && prevSeason >= MIN_SEASON) {
                    loadDashboardData(prevWeek, prevSeason).then(data => {
                        if (data && typeof data === 'object' && data.userPicks) {
                            if (!seasonCache[prevSeason]) seasonCache[prevSeason] = {};
                            seasonCache[prevSeason][prevWeek] = data;
                            console.log(`Preloaded ${prevSeason} Week ${prevWeek}`);
                        } else {
                            console.warn(`Not preloading invalid data for ${prevSeason} Week ${prevWeek}, type:`, typeof data);
                        }
                    });
                }
                
                // Preload next week
                let nextWeek = currentDisplayedWeek + 1;
                let nextSeason = currentDisplayedSeason;
                if (nextWeek > 18 && currentDisplayedSeason < MAX_SEASON) {
                    nextWeek = 1;
                    nextSeason = currentDisplayedSeason + 1;
                }
                if (nextWeek <= 18 && nextSeason <= MAX_SEASON) {
                    loadDashboardData(nextWeek, nextSeason).then(data => {
                        if (data && typeof data === 'object' && data.userPicks) {
                            if (!seasonCache[nextSeason]) seasonCache[nextSeason] = {};
                            seasonCache[nextSeason][nextWeek] = data;
                            console.log(`Preloaded ${nextSeason} Week ${nextWeek}`);
                        } else {
                            console.warn(`Not preloading invalid data for ${nextSeason} Week ${nextWeek}, type:`, typeof data);
                        }
                    });
                }
            }, 1000); // Wait 1s before preloading to let page fully load
        });
    </script>
</body>
</html>