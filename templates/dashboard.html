<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{{.Title}}</title>
    <script>
        // Apply dark theme by default to match legacy
        (function() {
            const savedTheme = localStorage.getItem('theme') || 'dark';
            if (savedTheme === 'light') {
                document.documentElement.setAttribute('data-theme', 'light');
            }
        })();
    </script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@300;400;500;700&display=block" rel="stylesheet">
    <script src="https://unpkg.com/htmx.org@1.9.10"></script>
    <script src="https://unpkg.com/htmx.org@1.9.10/dist/ext/sse.js"></script>
    <link rel="stylesheet" href="/static/style.css">
</head>
<body>
    <!-- Navigation Bar - Exact Material Design mat-toolbar -->
    <mat-toolbar class="mat-toolbar">
        <a href="/" class="nav-brand">PC '25</a>
        <div class="nav-links">
            <a href="/" class="nav-link active">Dashboard</a>
            <a href="/analytics" class="nav-link">Statistics</a>
        </div>
        <div class="flex-expand"></div>
        <div class="nav-controls">
            {{if .User}}
                <span class="user-info">{{.User.Name}}</span>
                <a href="/logout" class="logout-button">Logout</a>
            {{else}}
                <a href="/login" class="login-button">Login</a>
            {{end}}
            <button class="theme-toggle" id="theme-toggle">☀️</button>
        </div>
    </mat-toolbar>

    <!-- Dashboard Container - Exact legacy three-column layout -->
    <!-- SSE listener - persistent across navigation -->
    <div id="sse-listener" 
         hx-ext="sse" 
         sse-connect="/events">
        <!-- User picks updates listener - OOB only -->
        <div sse-swap="user-picks-updated" 
             hx-swap="none"></div>
        
        <!-- Dashboard updates listener -->
        <div sse-swap="dashboard-update" 
             hx-swap="innerHTML" 
             hx-target="#dashboard-content"></div>
             
        <!-- Visibility change updates listener -->
        <div sse-swap="visibility-change" 
             hx-swap="none" 
             hx-trigger="sse:visibility-change"
             hx-get="/"
             hx-target="#dashboard-content"></div>
             
        <!-- Game status updates listener - OOB approach -->
        <div sse-swap="gameStatus" 
             hx-swap="none"></div>
             
        <!-- Game scores updates listener - OOB approach -->  
        <div sse-swap="gameScores"
             hx-swap="none"></div>
             
        <!-- Pick updates listener - OOB approach -->
        <div sse-swap="pickUpdates"
             hx-swap="none"></div>
             
        <!-- Individual game score updates listener -->
        <div sse-swap="gameScoreUpdate" 
             hx-swap="outerHTML"
             hx-target-404="#nonexistent"></div>
             
    </div>
         
    <div class="dashboard-container">        
        <div class="dashboard-content" id="dashboard-content">
            {{template "dashboard-content" .}}
        </div>
        
        <!-- Mobile-only Statistics button -->
        <div class="mobile-stats-button">
            <a href="/analytics" class="stats-button">Show Statistics</a>
        </div>
    </div>

    <!-- Template for game grid that will be updated via SSE - Inline Grid Structure -->
    {{define "game-grid"}}
        <div class="games-list-container" id="games-container">
            {{range .Games}}
                <div class="game-row inline-game {{if eq .State "in_play"}}in-progress{{else}}{{.State}}{{end}}" id="game-{{.ID}}">
                    <div class="game-matchup">
                        <div class="matchup-team">
                            <img class="team-img" src="{{.GetAwayTeamIconURL}}" alt="{{.Away}}" onerror="this.style.display='none'"/>
                            <div class="team-name-spread">
                                <span class="team-name-container">
                                    <span class="team-abbr">{{.Away}}</span>
                                </span>
                                {{if .HasOdds}}<span class="team-spread">{{.FormatAwaySpread}}</span>{{end}}
                            </div>
                            {{if ne .State "scheduled"}}
                                <span class="team-score" id="away-score-{{.ID}}">{{.AwayScore}}</span>
                            {{else}}
                                <span class="team-score" id="away-score-{{.ID}}"></span>
                            {{end}}
                        </div>
                        <div class="matchup-team">
                            <img class="team-img" src="{{.GetHomeTeamIconURL}}" alt="{{.Home}}" onerror="this.style.display='none'"/>
                            <div class="team-name-spread">
                                <span class="team-name-container">
                                    <span class="team-abbr">{{.Home}}</span>
                                </span>
                                {{if .HasOdds}}<span class="team-spread">{{.FormatHomeSpread}}</span>{{end}}
                            </div>
                            {{if ne .State "scheduled"}}
                                <span class="team-score" id="home-score-{{.ID}}">{{.HomeScore}}</span>
                            {{else}}
                                <span class="team-score" id="home-score-{{.ID}}"></span>
                            {{end}}
                        </div>
                    </div>
                    <div class="game-details">
                        {{if .HasOdds}}
                            <span class="ou-value">+{{.Odds.OU}}</span>
                        {{else}}
                            <span class="ou-value">-</span>
                        {{end}}
                    </div>
                    <div class="game-status-section" id="game-status-{{.ID}}">
                        {{if eq .State "scheduled"}}
                            <div class="game-time">{{.FormatGameTime}}</div>
                        {{else if eq .State "in_play"}}
                            {{template "game-results-display" .}}
                        {{else if eq .State "completed"}}
                            {{template "game-results-display" .}}
                        {{end}}
                    </div>
                </div>
                {{if eq .State "in_play"}}
                    <!-- Always visible game expansion -->
                    <div class="live-game-expansion">
                        <!-- Game Clock and Quarter -->
                        <span class="status-item game-clock" id="game-time-{{.ID}}">
                            {{if eq .Quarter 5}}OT{{else if eq .Quarter 6}}2OT{{else}}Q{{.Quarter}}{{end}}
                            {{if .HasStatus}}{{if ne .GetGameClock ""}} {{.GetGameClock}}{{end}}{{end}}
                        </span>
                        
                        <!-- Game Status and Possession -->
                        {{if .HasStatus}}
                            {{$possessionStr := .GetPossessionString}}
                            {{if ne $possessionStr ""}}
                                <span class="status-divider"> || </span>
                                <span class="status-item" id="possession-{{.ID}}">{{$possessionStr}}</span>
                            {{end}}
                        {{end}}
                        
                        {{if or (.HasOdds) (.HasStatus)}}
                            <span class="status-divider"> || </span>
                        {{end}}
                        
                        <!-- O/U Status with tracking -->
                        {{template "ou-projection-status" .}}
                        
                        <!-- Red Zone Indicator -->
                        {{if .HasStatus}}
                            {{if .Status.IsRedZone}}
                                <span class="status-divider"> || </span>
                                <span class="status-item" style="color: #e74c3c; font-weight: bold;">RED ZONE</span>
                            {{end}}
                        {{end}}
                    </div>
                {{end}}
            {{end}}
        </div>
    {{end}}

    <!-- Dashboard Content Template (for HTMX partial updates) -->
    {{define "dashboard-content"}}
        <!-- Left Column: Pick Lists - Material Design Structure -->
        <div class="pick-flex-item">
            <!-- Week Selector with mat-form-field structure -->
            <div class="week-selector-container">
                <div class="form-field">
                    <label for="week-select" class="form-label">View Week</label>
                    <select id="week-select" name="week" class="week-select" 
                            hx-get="/" 
                            hx-target="#dashboard-content"
                            hx-include="[name='season']"
                            hx-trigger="change">
                        {{range .Weeks}}
                            <option value="{{.}}" {{if eq . $.CurrentWeek}}selected{{end}}>
                                Week {{.}}
                            </option>
                        {{end}}
                    </select>
                    <input type="hidden" name="season" value="{{.CurrentSeason}}">
                </div>
                {{if .User}}
                    <button class="update-picks-btn"
                            hx-get="/pick-picker?week={{.CurrentWeek}}&season={{.CurrentSeason}}"
                            hx-target="body"
                            hx-swap="beforeend">
                        Update Picks
                    </button>
                {{end}}
            </div>
            <div id="picks-container">
                {{template "picks-section" .}}
            </div>
        </div>

        <!-- Center Column: Current Games - Material Design Structure -->
        <div class="game-flex-item">

            <!-- Games Grid with inline structure -->
            <div class="games-container">
                <div class="section-header" id="games-header">CURRENT GAMES</div>
                {{template "game-grid" .}}
            </div>
        </div>

        <!-- Right Column: Club Scores - Material Design Structure -->
        <div class="score-flex-item">
            <div class="section-header">CLUB SCORE</div>
            <div class="club-scores">
                {{template "club-scores-content" .}}
            </div>
        </div>
    {{end}}

    {{define "picks-section"}}
{{debugLog "picks-section template started"}}
{{if .UserPicks}}
    {{debugLog "UserPicks exists, checking User"}}
    {{if .User}}
        {{debugLog "User exists, calling sortUsersWithCurrentFirst"}}
        {{$sortedUserPicks := sortUsersWithCurrentFirst .UserPicks .User.Name}}
        {{debugLog "sortUsersWithCurrentFirst returned, starting range"}}
        {{range $index, $userPicks := $sortedUserPicks}}
            {{$isCurrentUser := eq .UserName $.User.Name}}
            {{template "user-picks-block" dict "UserPicks" . "Games" $.Games "IsCurrentUser" $isCurrentUser "IsFirst" (eq $index 0) "Season" $.CurrentSeason}}
        {{end}}
    {{else}}
        {{debugLog "No User, using basic range"}}
        {{range $index, $userPicks := .UserPicks}}
            {{template "user-picks-block" dict "UserPicks" . "Games" $.Games "IsCurrentUser" false "IsFirst" (eq $index 0) "Season" $.CurrentSeason}}
        {{end}}
    {{end}}
{{else}}
    <div class="user-picks-section mt-4">
        <div class="user-picks-header">My Picks</div>
        <div class="user-picks-content">
            <div class="no-picks">Please log in to see picks</div>
        </div>
    </div>
{{end}}
{{end}}

    {{define "user-picks-block"}}
{{$userPicks := .UserPicks}}{{$games := .Games}}{{$isCurrentUser := .IsCurrentUser -}}
{{$season := .Season -}}
<div class="user-picks-section" id="user-picks-{{$userPicks.UserID}}" data-user-id="{{$userPicks.UserID}}">
<div class="user-picks-header">
{{if $isCurrentUser}}MY PICKS{{else}}{{$userPicks.UserName}}'S PICKS{{end}}
</div>
<div class="user-picks-content">

{{/* Check if this is a modern season (2025+) for daily display */}}
{{if ge $season 2025}}
    {{/* MODERN: 2025+ Daily Grouping Display */}}
    {{if hasDailyGroups $userPicks}}
        {{template "modern-daily-picks" dict "DailyPickGroups" $userPicks.DailyPickGroups "Games" $games "IsCurrentUser" $isCurrentUser}}
    {{else}}
        {{/* Fallback: if DailyPickGroups not populated, show all picks in one section */}}
        {{if $userPicks.Picks}}
        <div class="regular-picks-section">
        <div class="picks-list">
        {{range sortPicksByGameTime $userPicks.Picks $games -}}
        {{template "unified-pick-item" dict "Pick" . "Games" $games "IsCurrentUser" $isCurrentUser -}}
        {{end -}}
        </div>
        </div>
        {{end}}
    {{end}}
{{else}}
    {{/* LEGACY: 2023-2024 Bonus Day Logic */}}
    {{if $userPicks.BonusThursdayPicks -}}
    <div class="regular-picks-section">
    <div class="picks-category-header">BONUS THURSDAY</div>
    <div class="picks-list">
    {{range sortPicksByGameTime $userPicks.BonusThursdayPicks $games -}}
    {{template "unified-pick-item" dict "Pick" . "Games" $games "IsCurrentUser" $isCurrentUser -}}
    {{end -}}
    </div>
    </div>
    {{end -}}
    {{if $userPicks.BonusFridayPicks -}}
    <div class="regular-picks-section">
    <div class="picks-category-header">BONUS FRIDAY</div>
    <div class="picks-list">
    {{range sortPicksByGameTime $userPicks.BonusFridayPicks $games -}}
    {{template "unified-pick-item" dict "Pick" . "Games" $games "IsCurrentUser" $isCurrentUser -}}
    {{end -}}
    </div>
    </div>
    {{end -}}
    {{if $userPicks.Picks -}}
    {{$hasAnyBonusPicks := or $userPicks.BonusThursdayPicks $userPicks.BonusFridayPicks -}}
    {{if $hasAnyBonusPicks -}}
    <div class="regular-picks-section">
    <div class="picks-category-header">REMAINING PICKS</div>
    <div class="picks-list">
    {{range sortPicksByGameTime $userPicks.Picks $games -}}
    {{$currentPick := . -}}
    {{$isBonus := false -}}
    {{range $userPicks.BonusThursdayPicks}}{{if eq .GameID $currentPick.GameID}}{{$isBonus = true}}{{end}}{{end -}}
    {{range $userPicks.BonusFridayPicks}}{{if eq .GameID $currentPick.GameID}}{{$isBonus = true}}{{end}}{{end -}}
    {{if not $isBonus -}}
    {{template "unified-pick-item" dict "Pick" . "Games" $games "IsCurrentUser" $isCurrentUser -}}
    {{end -}}
    {{end -}}
    </div>
    </div>
    {{else -}}
    <div class="regular-picks-section">
    <div class="picks-list">
    {{range sortPicksByGameTime $userPicks.Picks $games -}}
    {{template "unified-pick-item" dict "Pick" . "Games" $games "IsCurrentUser" $isCurrentUser -}}
    {{end -}}
    </div>
    </div>
    {{end -}}
    {{end -}}
{{end}}

{{/* Show hidden pick counts if user is not viewing their own picks */}}
{{if and (not $isCurrentUser) $userPicks.HiddenPickCounts -}}
{{$hasHiddenPicks := false -}}
{{range $day, $count := $userPicks.HiddenPickCounts}}{{if gt $count 0}}{{$hasHiddenPicks = true}}{{end}}{{end -}}
{{if $hasHiddenPicks -}}
<div class="hidden-picks-section">
<div class="picks-category-header">HIDDEN PICKS</div>
<div class="hidden-picks-summary">
{{/* Display hidden picks in chronological order */}}
{{/* Check if this is a modern season (2025+) based on the presence of separate Sunday/Monday keys */}}
{{$isModernSeason := false -}}
{{if index $userPicks.HiddenPickCounts "Sunday"}}{{$isModernSeason = true}}{{end -}}
{{if index $userPicks.HiddenPickCounts "Monday"}}{{$isModernSeason = true}}{{end -}}

{{if $isModernSeason -}}
    {{/* Modern seasons: separate Sunday and Monday */}}
    {{$orderedDays := (slice "Thursday" "Friday" "Saturday" "Sunday" "Monday") -}}
    {{range $orderedDays -}}
    {{$count := index $userPicks.HiddenPickCounts . -}}
    {{if gt $count 0 -}}
    <div class="hidden-pick-count">
    <span class="day-name">{{.}}:</span>
    <span class="count-value">{{$count}} pick{{if ne $count 1}}s{{end}}</span>
    </div>
    {{end -}}
    {{end -}}
{{else -}}
    {{/* Legacy seasons: combined Sunday/Monday */}}
    {{$orderedDays := (slice "Thursday" "Friday" "Saturday" "Sunday/Monday") -}}
    {{range $orderedDays -}}
    {{$count := index $userPicks.HiddenPickCounts . -}}
    {{if gt $count 0 -}}
    <div class="hidden-pick-count">
    <span class="day-name">{{.}}:</span>
    <span class="count-value">{{$count}} pick{{if ne $count 1}}s{{end}}</span>
    </div>
    {{end -}}
    {{end -}}
{{end -}}
<div class="hidden-picks-note">Picks will be revealed based on game schedule</div>
</div>
</div>
{{end -}}
{{end -}}

</div>
</div>
    {{end}}

    <!-- Modern Daily Picker Template (2025+) -->
    {{define "modern-daily-picker"}}
    {{$games := .Games}}{{$pickState := .PickState -}}
    
    {{/* Thursday Games */}}
    {{$hasThursdayGames := false -}}
    {{range $games -}}{{if eq (.GetGameDayName) "Thursday"}}{{$hasThursdayGames = true}}{{end}}{{end -}}
    {{if $hasThursdayGames -}}
    <div class="pick-day-section">
        <div class="pick-day-header">THURSDAY GAMES</div>
        <div class="pick-picker-grid">
            {{range $games -}}
                {{if eq (.GetGameDayName) "Thursday" -}}
                    {{template "pick-game-row" dict "Game" . "PickState" $pickState}}
                {{end -}}
            {{end -}}
        </div>
    </div>
    {{end -}}
    
    {{/* Friday Games */}}
    {{$hasFridayGames := false -}}
    {{range $games -}}{{if eq (.GetGameDayName) "Friday"}}{{$hasFridayGames = true}}{{end}}{{end -}}
    {{if $hasFridayGames -}}
    <div class="pick-day-section">
        <div class="pick-day-header">FRIDAY GAMES</div>
        <div class="pick-picker-grid">
            {{range $games -}}
                {{if eq (.GetGameDayName) "Friday" -}}
                    {{template "pick-game-row" dict "Game" . "PickState" $pickState}}
                {{end -}}
            {{end -}}
        </div>
    </div>
    {{end -}}
    
    {{/* Saturday Games */}}
    {{$hasSaturdayGames := false -}}
    {{range $games -}}{{if eq (.GetGameDayName) "Saturday"}}{{$hasSaturdayGames = true}}{{end}}{{end -}}
    {{if $hasSaturdayGames -}}
    <div class="pick-day-section">
        <div class="pick-day-header">SATURDAY GAMES</div>
        <div class="pick-picker-grid">
            {{range $games -}}
                {{if eq (.GetGameDayName) "Saturday" -}}
                    {{template "pick-game-row" dict "Game" . "PickState" $pickState}}
                {{end -}}
            {{end -}}
        </div>
    </div>
    {{end -}}
    
    {{/* Sunday Games */}}
    {{$hasSundayGames := false -}}
    {{range $games -}}{{if eq (.GetGameDayName) "Sunday"}}{{$hasSundayGames = true}}{{end}}{{end -}}
    {{if $hasSundayGames -}}
    <div class="pick-day-section">
        <div class="pick-day-header">SUNDAY GAMES</div>
        <div class="pick-picker-grid">
            {{range $games -}}
                {{if eq (.GetGameDayName) "Sunday" -}}
                    {{template "pick-game-row" dict "Game" . "PickState" $pickState}}
                {{end -}}
            {{end -}}
        </div>
    </div>
    {{end -}}
    
    {{/* Monday Games */}}
    {{$hasMondayGames := false -}}
    {{range $games -}}{{if eq (.GetGameDayName) "Monday"}}{{$hasMondayGames = true}}{{end}}{{end -}}
    {{if $hasMondayGames -}}
    <div class="pick-day-section">
        <div class="pick-day-header">MONDAY GAMES</div>
        <div class="pick-picker-grid">
            {{range $games -}}
                {{if eq (.GetGameDayName) "Monday" -}}
                    {{template "pick-game-row" dict "Game" . "PickState" $pickState}}
                {{end -}}
            {{end -}}
        </div>
    </div>
    {{end -}}
    {{end}}

    <!-- Pick Game Row Template (Reusable) -->
    {{define "pick-game-row"}}
    {{$game := .Game}}{{$pickState := .PickState -}}
    <div class="pick-game-row {{if ne $game.State "scheduled"}}game-disabled{{end}}" data-game-id="{{$game.ID}}">
        
        <!-- Away Team Pick -->
        <div class="pick-team-option">
            <label class="pick-checkbox-label {{if ne $game.State "scheduled"}}disabled{{end}}">
                <input type="checkbox" 
                       name="pick-{{$game.ID}}-away" 
                       value="1"
                       class="pick-checkbox"
                       {{if ne $game.State "scheduled"}}disabled{{end}}
                       {{if index (index $pickState $game.ID) 1}}checked{{end}}>
                <img class="pick-team-img" src="https://a.espncdn.com/combiner/i?img=/i/teamlogos/nfl/500/scoreboard/{{$game.Away | lower}}.png" alt="{{$game.Away}}" onerror="this.style.display='none'">
                <div class="pick-text-container">
                    <span class="pick-team-name">{{$game.Away}}</span>
                    {{if $game.Odds}}
                        <span class="pick-spread">{{formatAwaySpread $game.Odds}}</span>
                    {{end}}
                </div>
            </label>
        </div>
        
        <!-- Home Team Pick -->
        <div class="pick-team-option">
            <label class="pick-checkbox-label {{if ne $game.State "scheduled"}}disabled{{end}}">
                <input type="checkbox" 
                       name="pick-{{$game.ID}}-home" 
                       value="1"
                       class="pick-checkbox"
                       {{if ne $game.State "scheduled"}}disabled{{end}}
                       {{if index (index $pickState $game.ID) 2}}checked{{end}}>
                <img class="pick-team-img" src="https://a.espncdn.com/combiner/i?img=/i/teamlogos/nfl/500/scoreboard/{{$game.Home | lower}}.png" alt="{{$game.Home}}" onerror="this.style.display='none'">
                <div class="pick-text-container">
                    <span class="pick-team-name">{{$game.Home}}</span>
                    {{if $game.Odds}}
                        <span class="pick-spread">{{formatHomeSpread $game.Odds}}</span>
                    {{end}}
                </div>
            </label>
        </div>
        
        <!-- O/U Display -->
        <div class="pick-ou-display">
            {{if $game.Odds}}+{{$game.Odds.OU}}{{else}}-{{end}}
        </div>
        
        <!-- Under Pick -->
        <div class="pick-team-option">
            <label class="pick-checkbox-label {{if ne $game.State "scheduled"}}disabled{{end}}">
                <input type="checkbox" 
                       name="pick-{{$game.ID}}-98" 
                       value="1"
                       class="pick-checkbox"
                       {{if ne $game.State "scheduled"}}disabled{{end}}
                       {{if index (index $pickState $game.ID) 98}}checked{{end}}>
                <img class="pick-team-img" src="https://api.iconify.design/mdi/chevron-double-down.svg" alt="UND">
            </label>
        </div>
        
        <!-- Over Pick -->
        <div class="pick-team-option">
            <label class="pick-checkbox-label {{if ne $game.State "scheduled"}}disabled{{end}}">
                <input type="checkbox" 
                       name="pick-{{$game.ID}}-99" 
                       value="1"
                       class="pick-checkbox"
                       {{if ne $game.State "scheduled"}}disabled{{end}}
                       {{if index (index $pickState $game.ID) 99}}checked{{end}}>
                <img class="pick-team-img" src="https://api.iconify.design/mdi/chevron-double-up.svg" alt="OVR">
            </label>
        </div>
    </div>
    {{end}}

    <!-- Unified Pick Item Template -->
    {{define "unified-pick-item"}}
        {{$pick := .Pick}}
        {{$games := .Games}}
        {{$isCurrentUser := .IsCurrentUser}}
        {{$game := findGameByID $games $pick.GameID}}
        <div class="pick-item {{getResultClass $pick $game}}" id="pick-item-{{$pick.GameID}}-{{$pick.UserID}}">
            <div class="pick-matchup">
                {{if $game}}
                    <!-- Away team -->
                    <img class="team-img" src="{{$game.GetAwayTeamIconURL}}" alt="{{$game.Away}}" onerror="this.style.display='none'"/>
                    <div class="team-info{{if and (or (contains $pick.TeamName $game.Away) (eq $pick.TeamName $game.Away)) (ne $pick.PickType "over_under")}} picked{{end}}">
                        <span class="team-abbr">{{$game.Away}}</span>
                        {{if ne $game.State "scheduled"}}
                            <span class="team-score" id="away-score-{{$game.ID}}">{{$game.AwayScore}}</span>
                        {{else}}
                            <span class="team-score" id="away-score-{{$game.ID}}">-</span>
                        {{end}}
                    </div>
                    
                    <!-- Home team -->
                    <img class="team-img" src="{{$game.GetHomeTeamIconURL}}" alt="{{$game.Home}}" onerror="this.style.display='none'"/>
                    <div class="team-info{{if and (or (contains $pick.TeamName $game.Home) (eq $pick.TeamName $game.Home)) (ne $pick.PickType "over_under")}} picked{{end}}">
                        <span class="team-abbr">{{$game.Home}}</span>
                        {{if ne $game.State "scheduled"}}
                            <span class="team-score" id="home-score-{{$game.ID}}">{{$game.HomeScore}}</span>
                        {{else}}
                            <span class="team-score" id="home-score-{{$game.ID}}">-</span>
                        {{end}}
                    </div>
                {{end}}
            </div>
            <div class="pick-details">
                <!-- DEBUG: TeamName='{{$pick.TeamName}}' PickType='{{$pick.PickType}}' TeamID={{$pick.TeamID}} -->
                {{if $pick.TeamName}}
                    {{if eq $pick.PickType "over_under"}}
                        <!-- Over/Under pick display -->
                        {{if eq $pick.TeamID 99}}
                            <img class="team-img" src="https://api.iconify.design/mdi/chevron-double-up.svg" alt="OVR"/>
                            {{if and $game $game.HasOdds}}
                                <div class="pick-value">
                                    {{if ne $game.State "scheduled"}}
                                        {{$currentTotal := add $game.AwayScore $game.HomeScore}}
                                        {{$currentTotalFloat := float64 $currentTotal}}
                                        {{$overUnder := $game.Odds.OU}}
                                        {{$colorClass := ""}}
                                        {{if eq $game.State "in_play"}}
                                            {{if ge $currentTotalFloat $overUnder}}
                                                {{$colorClass = "pick-status-winning"}}
                                            {{else if $game.HasStatus}}
                                                {{$projectedTotal := projectFinalScore $game.HomeScore $game.AwayScore $game.Quarter $game.GetGameClock}}
                                                {{if ge $projectedTotal $overUnder}}
                                                    {{$colorClass = "pick-status-pace"}}
                                                {{else}}
                                                    {{$colorClass = "pick-status-failing"}}
                                                {{end}}
                                            {{else}}
                                                {{$colorClass = "pick-status-pace"}}
                                            {{end}}
                                        {{end}}
                                        <span class="current-value {{$colorClass}}">{{$currentTotal}}</span>
                                        <span class="separator">/</span>
                                        <span class="target-value">{{$overUnder}}</span>
                                    {{else}}
                                        <span class="target-value">+{{$game.Odds.OU}}</span>
                                    {{end}}
                                </div>
                            {{end}}
                        {{else}}
                            <img class="team-img" src="https://api.iconify.design/mdi/chevron-double-down.svg" alt="UND"/>
                            {{if and $game $game.HasOdds}}
                                <div class="pick-value">
                                    {{if ne $game.State "scheduled"}}
                                        {{$currentTotal := add $game.AwayScore $game.HomeScore}}
                                        {{$currentTotalFloat := float64 $currentTotal}}
                                        {{$overUnder := $game.Odds.OU}}
                                        {{$colorClass := ""}}
                                        {{if eq $game.State "in_play"}}
                                            {{if ge $currentTotalFloat $overUnder}}
                                                {{$colorClass = "pick-status-losing"}}
                                            {{else if $game.HasStatus}}
                                                {{$projectedTotal := projectFinalScore $game.HomeScore $game.AwayScore $game.Quarter $game.GetGameClock}}
                                                {{if lt $projectedTotal $overUnder}}
                                                    {{$colorClass = "pick-status-pace"}}
                                                {{else}}
                                                    {{$colorClass = "pick-status-failing"}}
                                                {{end}}
                                            {{else}}
                                                {{$colorClass = "pick-status-pace"}}
                                            {{end}}
                                        {{end}}
                                        <span class="current-value {{$colorClass}}">{{$currentTotal}}</span>
                                        <span class="separator">/</span>
                                        <span class="target-value">{{$overUnder}}</span>
                                    {{else}}
                                        <span class="target-value">+{{$game.Odds.OU}}</span>
                                    {{end}}
                                </div>
                            {{end}}
                        {{end}}
                    {{else}}
                        <!-- Spread pick display - show team icon and spread data -->
                        {{if and $game (or (contains $pick.TeamName $game.Away) (eq $pick.TeamName $game.Away))}}
                            <img class="team-img" src="{{$game.GetAwayTeamIconURL}}" alt="{{$game.Away}}" onerror="this.style.display='none'"/>
                            <div class="pick-value">
                                {{if ne $game.State "scheduled"}}
                                    {{$differential := minus $game.HomeScore $game.AwayScore}}
                                    {{$colorClass := ""}}
                                    {{if eq $game.State "in_play"}}
                                        {{$coverStatus := isPickedTeamCovering $pick $game}}
                                        {{if eq $coverStatus "covering"}}
                                            {{$colorClass = "pick-status-winning"}}
                                        {{else if eq $coverStatus "push"}}
                                            {{$colorClass = "pick-status-push"}}
                                        {{else}}
                                            {{$colorClass = "pick-status-losing"}}
                                        {{end}}
                                    {{end}}
                                    <span class="current-value {{$colorClass}}">{{if eq $differential 0}}TIE{{else if gt $differential 0}}+{{$differential}}{{else}}{{$differential}}{{end}}</span>
                                    <span class="separator">/</span>
                                    <span class="target-value">{{$game.FormatAwaySpread}}</span>
                                {{else}}
                                    <span class="target-value">{{$game.FormatAwaySpread}}</span>
                                {{end}}
                            </div>
                        {{else if and $game (or (contains $pick.TeamName $game.Home) (eq $pick.TeamName $game.Home))}}
                            <img class="team-img" src="{{$game.GetHomeTeamIconURL}}" alt="{{$game.Home}}" onerror="this.style.display='none'"/>
                            <div class="pick-value">
                                {{if ne $game.State "scheduled"}}
                                    {{$differential := minus $game.AwayScore $game.HomeScore}}
                                    {{$colorClass := ""}}
                                    {{if eq $game.State "in_play"}}
                                        {{$coverStatus := isPickedTeamCovering $pick $game}}
                                        {{if eq $coverStatus "covering"}}
                                            {{$colorClass = "pick-status-winning"}}
                                        {{else if eq $coverStatus "push"}}
                                            {{$colorClass = "pick-status-push"}}
                                        {{else}}
                                            {{$colorClass = "pick-status-losing"}}
                                        {{end}}
                                    {{end}}
                                    <span class="current-value {{$colorClass}}">{{if eq $differential 0}}TIE{{else if gt $differential 0}}+{{$differential}}{{else}}{{$differential}}{{end}}</span>
                                    <span class="separator">/</span>
                                    <span class="target-value">{{$game.FormatHomeSpread}}</span>
                                {{else}}
                                    <span class="target-value">{{$game.FormatHomeSpread}}</span>
                                {{end}}
                            </div>
                        {{else}}
                            <!-- Fallback for unknown team -->
                            <img class="team-img" src="https://api.iconify.design/mdi/help.svg" alt="?"/>
                            <div class="pick-value">
                                <span class="target-value">{{$pick.TeamName}}</span>
                            </div>
                        {{end}}
                    {{end}}
                {{else}}
                    <img class="team-img" src="https://api.iconify.design/mdi/help.svg" alt="?"/>
                    <div class="pick-value">
                        <span class="target-value">-</span>
                    </div>
                {{end}}
            </div>
        </div>
        {{if and $game (eq $game.State "in_play")}}
            <div class="live-pick-expansion">
                <span class="game-clock" id="game-time-{{$game.ID}}">{{$game.GetGameClock}} {{if eq $game.Quarter 5}}OT{{else if eq $game.Quarter 6}}2OT{{else}}Q{{$game.Quarter}}{{end}}</span>
                
                {{if $game.HasStatus}}
                    {{$possessionStr := $game.GetPossessionString}}
                    {{if ne $possessionStr ""}}
                        <span class="status-divider"> || </span>
                        <span class="game-possession" id="possession-{{$game.ID}}">{{$possessionStr}}</span>
                    {{end}}
                    {{if and $game.HasStatus $game.Status.IsRedZone}}
                        <span class="status-divider"> || </span>
                        <span class="red-zone-indicator">RED ZONE</span>
                    {{end}}
                {{end}}
                
                {{/* Show O/U projection for O/U picks only */}}
                {{if isOverUnder $pick}}
                    <span class="status-divider"> || </span>
                    {{template "ou-projection-status" $game}}
                {{end}}
            </div>
        {{end}}
    {{end}}

    <!-- Pick Picker Modal Template -->
    {{define "pick-picker"}}
        <div id="pick-picker-overlay" class="pick-picker-overlay">
            <div class="pick-picker-modal">
                <div class="pick-picker-header">
                    <h2>Week {{.CurrentWeek}}</h2>
                    <button class="close-picker">×</button>
                </div>
                <form id="pick-form" 
                      hx-post="/submit-picks" 
                      hx-target="#pick-result" 
                      hx-swap="innerHTML">
                    <input type="hidden" name="week" value="{{.CurrentWeek}}">
                    <input type="hidden" name="season" value="{{.CurrentSeason}}">
                    
                    <div class="pick-picker-content">
                        {{if .Games}}
                            {{/* Check if this is a modern season (2025+) for daily grouping */}}
                            {{if ge .CurrentSeason 2025}}
                                {{/* MODERN: 2025+ Daily Picker with Day Sections */}}
                                {{template "modern-daily-picker" dict "Games" .Games "PickState" .PickState "CurrentSeason" .CurrentSeason}}
                            {{else}}
                                {{/* LEGACY: 2023-2024 All Games in One List */}}
                                <div class="pick-picker-grid">
                                    {{range .Games}}
                                        {{template "pick-game-row" dict "Game" . "PickState" $.PickState}}
                                    {{end}}
                                </div>
                            {{end}}
                        {{else}}
                            <p>No games available for picking this week.</p>
                        {{end}}
                    </div>
                    
                    <div class="pick-picker-footer">
                        <div id="pick-result"></div>
                        <button type="submit" class="submit-picks-btn">Submit Picks</button>
                        <button type="button" class="cancel-picks-btn">Cancel</button>
                    </div>
                </form>
            </div>
        </div>
    {{end}}

    <script>
        // SSE Week Filtering - Only act on events for the current week/season being viewed
        document.addEventListener('htmx:sseBeforeMessage', function(e) {
            // Only filter gameUpdate events
            if (e.detail.type === 'gameUpdate') {
                try {
                    const eventData = JSON.parse(e.detail.data);
                    const listener = document.querySelector('[sse-swap="gameUpdate"][data-filter-events="true"]');
                    
                    if (listener) {
                        const currentSeason = parseInt(listener.getAttribute('data-current-season'));
                        const currentWeek = parseInt(listener.getAttribute('data-current-week'));
                        
                        // Check if the event is for the current week/season
                        if (eventData.season && eventData.week) {
                            if (eventData.season !== currentSeason || eventData.week !== currentWeek) {
                                console.log(`SSE: Filtering out gameUpdate for season ${eventData.season}, week ${eventData.week} (current: season ${currentSeason}, week ${currentWeek})`);
                                e.preventDefault(); // Prevent this event from being processed
                                return;
                            }
                        }
                        
                        console.log(`SSE: Processing gameUpdate for season ${eventData.season || 'unknown'}, week ${eventData.week || 'unknown'} (matches current view)`);
                        
                        // Append season/week params to the refresh URL
                        const refreshUrl = `/games/refresh?season=${currentSeason}&week=${currentWeek}`;
                        listener.setAttribute('hx-get', refreshUrl);
                    }
                } catch (err) {
                    console.log('SSE: Could not parse gameUpdate event data:', err);
                }
            }
        });

        // Set up mutual exclusion for pick checkboxes
        function setupPickMutualExclusion(container) {
            const checkboxes = container.querySelectorAll('.pick-checkbox');
            
            checkboxes.forEach(checkbox => {
                checkbox.addEventListener('change', function() {
                    if (this.checked) {
                        const parts = this.name.split('-');
                        if (parts.length === 3) {
                            const gameId = parts[1];
                            const selectedType = parts[2];
                            
                            // Find mutually exclusive checkbox
                            let exclusiveType;
                            if (selectedType === 'away') {
                                exclusiveType = 'home';
                            } else if (selectedType === 'home') {
                                exclusiveType = 'away';
                            } else if (selectedType === '98') { // Under
                                exclusiveType = '99'; // Over
                            } else if (selectedType === '99') { // Over
                                exclusiveType = '98'; // Under
                            }
                            
                            if (exclusiveType) {
                                const exclusiveCheckbox = container.querySelector(`input[name="pick-${gameId}-${exclusiveType}"]`);
                                if (exclusiveCheckbox && exclusiveCheckbox.checked) {
                                    exclusiveCheckbox.checked = false;
                                }
                            }
                        }
                    }
                });
            });
        }

        // Only essential functionality - theme toggle and keyboard navigation
        document.getElementById('theme-toggle').addEventListener('click', function() {
            const html = document.documentElement;
            const currentTheme = html.getAttribute('data-theme');
            const newTheme = currentTheme === 'light' ? 'dark' : 'light';
            
            html.setAttribute('data-theme', newTheme);
            localStorage.setItem('theme', newTheme);
        });

        // Keyboard navigation for week traversal with season wrapping
        document.addEventListener('keydown', function(event) {
            if (event.target.tagName === 'INPUT' || event.target.tagName === 'TEXTAREA') {
                return; // Don't interfere with form inputs
            }
            
            const weekSelect = document.getElementById('week-select');
            const seasonInput = document.querySelector('input[name="season"]');
            if (!weekSelect || !seasonInput) return;
            
            const currentWeek = parseInt(weekSelect.value);
            const currentSeason = parseInt(seasonInput.value);
            let newWeek = currentWeek;
            let newSeason = currentSeason;
            
            if (event.key === 'ArrowLeft') {
                if (currentWeek > 1) {
                    newWeek = currentWeek - 1;
                } else if (currentSeason > 2023) {
                    // Wrap to previous season, week 18
                    newWeek = 18;
                    newSeason = currentSeason - 1;
                }
            } else if (event.key === 'ArrowRight') {
                if (currentWeek < 18) {
                    newWeek = currentWeek + 1;
                } else if (currentSeason < 2025) {
                    // Wrap to next season, week 1
                    newWeek = 1;
                    newSeason = currentSeason + 1;
                }
            }
            
            if (newWeek !== currentWeek || newSeason !== currentSeason) {
                // Update the form values
                weekSelect.value = newWeek;
                seasonInput.value = newSeason;
                
                // Trigger the HTMX change event on the select element
                htmx.trigger(weekSelect, 'change');
                event.preventDefault();
            }
        });

        // Mobile swipe navigation for week traversal
        let touchStartX = 0;
        let touchStartY = 0;
        let touchEndX = 0;
        let touchEndY = 0;
        
        document.addEventListener('touchstart', function(event) {
            touchStartX = event.changedTouches[0].screenX;
            touchStartY = event.changedTouches[0].screenY;
        });
        
        document.addEventListener('touchend', function(event) {
            touchEndX = event.changedTouches[0].screenX;
            touchEndY = event.changedTouches[0].screenY;
            handleSwipe();
        });
        
        function handleSwipe() {
            const deltaX = touchEndX - touchStartX;
            const deltaY = touchEndY - touchStartY;
            const minSwipeDistance = 50;
            
            // Only process horizontal swipes that are longer than vertical swipes
            if (Math.abs(deltaX) > Math.abs(deltaY) && Math.abs(deltaX) > minSwipeDistance) {
                const weekSelect = document.getElementById('week-select');
                const seasonInput = document.querySelector('input[name="season"]');
                
                if (!weekSelect || !seasonInput) return;
                
                const currentWeek = parseInt(weekSelect.value);
                const currentSeason = parseInt(seasonInput.value);
                let newWeek = currentWeek;
                let newSeason = currentSeason;
                
                if (deltaX > 0) {
                    // Swipe left-to-right: go to previous week (same as ArrowLeft)
                    if (currentWeek > 1) {
                        newWeek = currentWeek - 1;
                    } else if (currentSeason > 2023) {
                        // Wrap to previous season, week 18
                        newWeek = 18;
                        newSeason = currentSeason - 1;
                    }
                } else {
                    // Swipe right-to-left: go to next week (same as ArrowRight)
                    if (currentWeek < 18) {
                        newWeek = currentWeek + 1;
                    } else if (currentSeason < 2025) {
                        // Wrap to next season, week 1
                        newWeek = 1;
                        newSeason = currentSeason + 1;
                    }
                }
                
                if (newWeek !== currentWeek || newSeason !== currentSeason) {
                    // Update the form values
                    weekSelect.value = newWeek;
                    seasonInput.value = newSeason;
                    
                    // Trigger the HTMX change event on the select element
                    htmx.trigger(weekSelect, 'change');
                }
            }
        }

        // Modal management event listeners (CSP-compliant)
        document.addEventListener('htmx:afterSettle', function(event) {
            // Set up modal event listeners when pick picker is loaded
            const overlay = document.getElementById('pick-picker-overlay');
            if (overlay) {
                // Lock body scroll when modal opens
                document.body.classList.add('modal-open');
                
                // Set up mutual exclusion for pick checkboxes
                setupPickMutualExclusion(overlay);
                // Click outside modal to close
                overlay.addEventListener('click', function(e) {
                    if (e.target === overlay) {
                        document.body.classList.remove('modal-open');
                        overlay.remove();
                    }
                });
                
                // Close button
                const closeBtn = overlay.querySelector('.close-picker');
                if (closeBtn) {
                    closeBtn.addEventListener('click', function() {
                        document.body.classList.remove('modal-open');
                        overlay.remove();
                    });
                }
                
                // Cancel button
                const cancelBtn = overlay.querySelector('.cancel-picks-btn');
                if (cancelBtn) {
                    cancelBtn.addEventListener('click', function() {
                        document.body.classList.remove('modal-open');
                        overlay.remove();
                    });
                }
                
                // Form submission success
                const form = overlay.querySelector('#pick-form');
                if (form) {
                    form.addEventListener('htmx:afterRequest', function(e) {
                        if (e.detail.xhr.status === 200) {
                            document.body.classList.remove('modal-open');
                            overlay.remove();
                        }
                    });
                }
            }
        });

        // Listen for custom trigger from server
        document.addEventListener('picks-updated', function() {
            const overlay = document.getElementById('pick-picker-overlay');
            if (overlay) {
                document.body.classList.remove('modal-open');
                overlay.remove();
            }
        });

        // Debug HTMX SSE events
        document.addEventListener('htmx:sseMessage', function(e) {
            console.log('HTMX SSE Message received:', e.detail);
        });

        document.addEventListener('htmx:oobAfterSwap', function(e) {
            console.log('HTMX OOB swap completed:', e.detail);
        });

        // Log SSE connection status
        document.addEventListener('htmx:sseOpen', function(e) {
            console.log('SSE connection opened successfully');
        });
        
        // Debug DOM manipulation
        console.log('Page loaded - checking picks container structure');
        
        document.addEventListener('DOMContentLoaded', function() {
            const container = document.getElementById('picks-container');
            if (container) {
                console.log('Picks container found with', container.children.length, 'children');
                console.log('Container innerHTML preview:', container.innerHTML.substring(0, 200));
            }
        });
        
        // Monitor HTMX events
        document.addEventListener('htmx:afterSettle', function(e) {
            const target = e.detail && e.detail.target;
            const eventType = e.detail && e.detail.requestConfig ? 'user-initiated' : 'sse/programmatic';
            const targetInfo = target ? (target.id || target.tagName) : `no target (${eventType})`;
            console.log('HTMX afterSettle:', targetInfo);
        });
        
        document.addEventListener('htmx:afterSwap', function(e) {
            const target = e.detail && e.detail.target;
            const eventType = e.detail && e.detail.requestConfig ? 'user-initiated' : 'sse/programmatic';
            const targetInfo = target ? (target.id || target.tagName) : `no target (${eventType})`;
            console.log('HTMX afterSwap:', targetInfo);
            
            // Set up pick-picker event handlers if the pick-picker modal was loaded
            if (target && target.id === 'dashboard-container') {
                setupPickPickerHandlers();
            }
        });
        
        // Pick-picker modal handlers
        function setupPickPickerHandlers() {
            const pickPicker = document.getElementById('pick-picker-overlay');
            if (!pickPicker) return;
            
            // Close modal handlers
            const closeBtn = pickPicker.querySelector('.close-picker');
            const cancelBtn = pickPicker.querySelector('.cancel-picks-btn');
            
            if (closeBtn) {
                closeBtn.addEventListener('click', function() {
                    pickPicker.remove();
                    document.body.classList.remove('modal-open');
                });
            }
            
            if (cancelBtn) {
                cancelBtn.addEventListener('click', function() {
                    pickPicker.remove();
                    document.body.classList.remove('modal-open');
                });
            }
            
            // Handle clicks on disabled checkboxes to show feedback
            const disabledLabels = pickPicker.querySelectorAll('.pick-checkbox-label.disabled');
            disabledLabels.forEach(label => {
                label.addEventListener('click', function(e) {
                    e.preventDefault();
                    const resultDiv = document.getElementById('pick-result');
                    if (resultDiv) {
                        resultDiv.innerHTML = '<span style="color: var(--warning-color);">Cannot modify picks for games that have already started.</span>';
                        setTimeout(() => {
                            resultDiv.innerHTML = '';
                        }, 3000);
                    }
                });
            });
            
            // Prevent modal from closing when clicking inside the modal content
            const modal = pickPicker.querySelector('.pick-picker-modal');
            if (modal) {
                modal.addEventListener('click', function(e) {
                    e.stopPropagation();
                });
            }
            
            // Close modal when clicking the overlay
            pickPicker.addEventListener('click', function() {
                pickPicker.remove();
                document.body.classList.remove('modal-open');
            });
            
            // Add modal-open class to prevent body scrolling
            document.body.classList.add('modal-open');
        }
    </script>

    <!-- Pick Picker Modal JavaScript -->
    <script>
        // Set up mutual exclusion for pick checkboxes
        function setupPickMutualExclusion(container) {
            const checkboxes = container.querySelectorAll('.pick-checkbox');
            
            checkboxes.forEach(checkbox => {
                checkbox.addEventListener('change', function() {
                    if (this.checked) {
                        const parts = this.name.split('-');
                        if (parts.length === 3) {
                            const gameId = parts[1];
                            const selectedType = parts[2];
                            
                            // Find mutually exclusive checkbox
                            let exclusiveType;
                            if (selectedType === 'away') {
                                exclusiveType = 'home';
                            } else if (selectedType === 'home') {
                                exclusiveType = 'away';
                            } else if (selectedType === '98') { // Under
                                exclusiveType = '99'; // Over
                            } else if (selectedType === '99') { // Over
                                exclusiveType = '98'; // Under
                            }
                            
                            if (exclusiveType) {
                                const exclusiveCheckbox = container.querySelector(`input[name="pick-${gameId}-${exclusiveType}"]`);
                                if (exclusiveCheckbox && exclusiveCheckbox.checked) {
                                    exclusiveCheckbox.checked = false;
                                }
                            }
                        }
                    }
                });
            });
        }

        // Modal management event listeners (CSP-compliant)
        document.addEventListener('htmx:afterSettle', function(event) {
            // Set up modal event listeners when pick picker is loaded
            const overlay = document.getElementById('pick-picker-overlay');
            if (overlay) {
                // Lock body scroll when modal opens
                document.body.classList.add('modal-open');
                
                // Set up mutual exclusion for pick checkboxes
                setupPickMutualExclusion(overlay);
                
                // Click outside modal to close
                overlay.addEventListener('click', function(e) {
                    if (e.target === overlay) {
                        document.body.classList.remove('modal-open');
                        overlay.remove();
                    }
                });
                
                // Close button
                const closeBtn = overlay.querySelector('.close-picker');
                if (closeBtn) {
                    closeBtn.addEventListener('click', function() {
                        document.body.classList.remove('modal-open');
                        overlay.remove();
                    });
                }
                
                // Cancel button
                const cancelBtn = overlay.querySelector('.cancel-picks-btn');
                if (cancelBtn) {
                    cancelBtn.addEventListener('click', function() {
                        document.body.classList.remove('modal-open');
                        overlay.remove();
                    });
                }
                
                // Form submission success
                const form = overlay.querySelector('#pick-form');
                if (form) {
                    form.addEventListener('htmx:afterRequest', function(e) {
                        if (e.detail.xhr.status === 200) {
                            document.body.classList.remove('modal-open');
                            overlay.remove();
                        }
                    });
                }
            }
        });
    </script>
</body>
</html>

{{define "sse-game-clock"}}
<span class="status-item game-clock" id="game-time-{{.ID}}" hx-swap-oob="true">{{if eq .Quarter 5}}OT{{else if eq .Quarter 6}}2OT{{else}}Q{{.Quarter}}{{end}}{{if .HasStatus}}{{if ne .GetGameClock ""}} {{.GetGameClock}}{{end}}{{end}}</span>
{{end}}

{{define "sse-possession-info"}}
{{if .HasStatus}}{{$possessionStr := .GetPossessionString}}{{if ne $possessionStr ""}}<span class="status-item" id="possession-{{.ID}}" hx-swap-oob="true">{{$possessionStr}}</span>{{end}}{{end}}
{{end}}

{{define "ou-projection-status"}}
{{if .HasOdds}}
    {{$currentTotal := add .HomeScore .AwayScore}}
    {{$currentTotalFloat := float64 $currentTotal}}
    {{$overUnder := .Odds.OU}}
    {{if ge $currentTotalFloat $overUnder}}
        <span class="status-item ou-current" style="color: #e74c3c; font-weight: bold;">OVER</span>
    {{else}}
        {{/* Check if game is trending over or under based on projection */}}
        {{if .HasStatus}}
            {{$projectedTotal := projectFinalScore .HomeScore .AwayScore .Quarter .GetGameClock}}
            {{if ge $projectedTotal $overUnder}}
                <span class="status-item ou-current" style="color: #ff9800; font-weight: bold;">trending OVER ({{printf "%.0f" $projectedTotal}})</span>
            {{else}}
                <span class="status-item ou-current">trending UNDER ({{printf "%.0f" $projectedTotal}})</span>
            {{end}}
        {{else}}
            {{/* Without game status, assume trending under if below total */}}
            <span class="status-item ou-current">trending UNDER ({{$overUnder}})</span>
        {{end}}
    {{end}}
{{end}}
{{end}}

{{define "club-scores-content"}}
{{if .UserPicks}}
    {{$sortedUsers := sortUsersByScore .UserPicks}}
    {{range $sortedUsers}}
        <div class="score-item">
            <span class="user-name">{{.UserName}}</span>
            <span class="user-score">
                {{.Record.ParlayPoints}}
                {{if .Record.WeeklyPoints}}
                    <span class="weekly-gain">(+{{.Record.WeeklyPoints}})</span>
                {{end}}
            </span>
        </div>
    {{end}}
{{else}}
    {{range .Users}}
        <div class="score-item">
            <span class="user-name">{{.Name}}</span>
            <span class="user-score">0</span>
        </div>
    {{end}}
{{end}}
{{end}}



{{define "sse-user-picks-block"}}
{{$userPicks := .UserPicks}}{{$games := .Games}}{{$isCurrentUser := .IsCurrentUser -}}
{{$season := .Season -}}
<div class="user-picks-section" id="user-picks-{{$userPicks.UserID}}" data-user-id="{{$userPicks.UserID}}" hx-swap-oob="true">
<div class="user-picks-header">
{{if $isCurrentUser}}MY PICKS{{else}}{{$userPicks.UserName}}'S PICKS{{end}}
</div>
<div class="user-picks-content">

{{/* Check if this is a modern season (2025+) for daily display */}}
{{if ge $season 2025}}
    {{/* MODERN: 2025+ Daily Grouping Display */}}
    {{if hasDailyGroups $userPicks}}
        {{template "modern-daily-picks" dict "DailyPickGroups" $userPicks.DailyPickGroups "Games" $games "IsCurrentUser" $isCurrentUser}}
    {{else}}
        {{/* Fallback: if DailyPickGroups not populated, show all picks in one section */}}
        {{if $userPicks.Picks}}
        <div class="regular-picks-section">
        <div class="picks-list">
        {{range sortPicksByGameTime $userPicks.Picks $games -}}
        {{template "unified-pick-item" dict "Pick" . "Games" $games "IsCurrentUser" $isCurrentUser -}}
        {{end -}}
        </div>
        </div>
        {{end}}
    {{end}}
{{else}}
    {{/* LEGACY: 2023-2024 Bonus Day Logic */}}
    {{if $userPicks.BonusThursdayPicks -}}
    <div class="regular-picks-section">
    <div class="picks-category-header">BONUS THURSDAY</div>
    <div class="picks-list">
    {{range sortPicksByGameTime $userPicks.BonusThursdayPicks $games -}}
    {{template "unified-pick-item" dict "Pick" . "Games" $games "IsCurrentUser" $isCurrentUser -}}
    {{end -}}
    </div>
    </div>
    {{end -}}
    {{if $userPicks.BonusFridayPicks -}}
    <div class="regular-picks-section">
    <div class="picks-category-header">BONUS FRIDAY</div>
    <div class="picks-list">
    {{range sortPicksByGameTime $userPicks.BonusFridayPicks $games -}}
    {{template "unified-pick-item" dict "Pick" . "Games" $games "IsCurrentUser" $isCurrentUser -}}
    {{end -}}
    </div>
    </div>
    {{end -}}
    {{if $userPicks.Picks -}}
    {{$hasAnyBonusPicks := or $userPicks.BonusThursdayPicks $userPicks.BonusFridayPicks -}}
    {{if $hasAnyBonusPicks -}}
    <div class="regular-picks-section">
    <div class="picks-category-header">REMAINING PICKS</div>
    <div class="picks-list">
    {{range sortPicksByGameTime $userPicks.Picks $games -}}
    {{$currentPick := . -}}
    {{$isBonus := false -}}
    {{range $userPicks.BonusThursdayPicks}}{{if eq .GameID $currentPick.GameID}}{{$isBonus = true}}{{end}}{{end -}}
    {{range $userPicks.BonusFridayPicks}}{{if eq .GameID $currentPick.GameID}}{{$isBonus = true}}{{end}}{{end -}}
    {{if not $isBonus -}}
    {{template "unified-pick-item" dict "Pick" . "Games" $games "IsCurrentUser" $isCurrentUser -}}
    {{end -}}
    {{end -}}
    </div>
    </div>
    {{else -}}
    <div class="regular-picks-section">
    <div class="picks-list">
    {{range sortPicksByGameTime $userPicks.Picks $games -}}
    {{template "unified-pick-item" dict "Pick" . "Games" $games "IsCurrentUser" $isCurrentUser -}}
    {{end -}}
    </div>
    </div>
    {{end -}}
    {{end -}}
{{end}}

{{/* Show hidden pick counts if user is not viewing their own picks */}}
{{if and (not $isCurrentUser) $userPicks.HiddenPickCounts -}}
{{$hasHiddenPicks := false -}}
{{range $day, $count := $userPicks.HiddenPickCounts}}{{if gt $count 0}}{{$hasHiddenPicks = true}}{{end}}{{end -}}
{{if $hasHiddenPicks -}}
<div class="hidden-picks-section">
<div class="picks-category-header">HIDDEN PICKS</div>
<div class="hidden-picks-summary">
{{/* Display hidden picks in chronological order */}}
{{/* Check if this is a modern season (2025+) based on the presence of separate Sunday/Monday keys */}}
{{$isModernSeason := false -}}
{{if index $userPicks.HiddenPickCounts "Sunday"}}{{$isModernSeason = true}}{{end -}}
{{if index $userPicks.HiddenPickCounts "Monday"}}{{$isModernSeason = true}}{{end -}}

{{if $isModernSeason -}}
    {{/* Modern seasons: separate Sunday and Monday */}}
    {{$orderedDays := (slice "Thursday" "Friday" "Saturday" "Sunday" "Monday") -}}
    {{range $orderedDays -}}
    {{$count := index $userPicks.HiddenPickCounts . -}}
    {{if gt $count 0 -}}
    <div class="hidden-pick-count">
    <span class="day-name">{{.}}:</span>
    <span class="count-value">{{$count}} pick{{if ne $count 1}}s{{end}}</span>
    </div>
    {{end -}}
    {{end -}}
{{else -}}
    {{/* Legacy seasons: combined Sunday/Monday */}}
    {{$orderedDays := (slice "Thursday" "Friday" "Saturday" "Sunday/Monday") -}}
    {{range $orderedDays -}}
    {{$count := index $userPicks.HiddenPickCounts . -}}
    {{if gt $count 0 -}}
    <div class="hidden-pick-count">
    <span class="day-name">{{.}}:</span>
    <span class="count-value">{{$count}} pick{{if ne $count 1}}s{{end}}</span>
    </div>
    {{end -}}
    {{end -}}
{{end -}}
<div class="hidden-picks-note">Picks will be revealed based on game schedule</div>
</div>
</div>
{{end -}}
{{end -}}

</div>
</div>
{{end}}

{{define "game-results-display"}}
<div class="game-time completed-game-grid">
    <div class="spread-result-column">
        {{$spreadResult := .SpreadResult}}
        {{/* For in-progress games, calculate spread result in template since model method only works for completed games */}}
        {{if eq $spreadResult ""}}
            {{if .HasOdds}}
                {{$calculatedResult := calculateSpreadResult .HomeScore .AwayScore .Odds.Spread}}
                {{if eq $calculatedResult "home-covered"}}
                    {{$differential := minus .AwayScore .HomeScore}}
                    <span class="covering-pick">
                        <img class="covering-icon" src="{{.GetHomeTeamIconURL}}" alt="{{.Home}}" onerror="this.style.display='none'">
                        <span class="covering-team-text">{{if eq $differential 0}}TIE{{else if gt $differential 0}}+{{$differential}}{{else}}{{$differential}}{{end}}</span>
                        <span class="covering-team-mobile">{{if eq $differential 0}}TIE{{else if gt $differential 0}}+{{$differential}}{{else}}{{$differential}}{{end}}</span>
                    </span>
                {{else if eq $calculatedResult "away-covered"}}
                    {{$differential := minus .HomeScore .AwayScore}}
                    <span class="covering-pick">
                        <img class="covering-icon" src="{{.GetAwayTeamIconURL}}" alt="{{.Away}}" onerror="this.style.display='none'">
                        <span class="covering-team-text">{{if eq $differential 0}}TIE{{else if gt $differential 0}}+{{$differential}}{{else}}{{$differential}}{{end}}</span>
                        <span class="covering-team-mobile">{{if eq $differential 0}}TIE{{else if gt $differential 0}}+{{$differential}}{{else}}{{$differential}}{{end}}</span>
                    </span>
                {{else if eq $calculatedResult "push"}}
                    <span class="covering-pick push-pick">
                        <span class="covering-team-text">PUSH</span>
                        <span class="covering-team-mobile">PUSH</span>
                    </span>
                {{end}}
            {{end}}
        {{else}}
            {{/* Use existing spread result for completed games */}}
            {{if eq $spreadResult "home-covered"}}
                {{$differential := minus .AwayScore .HomeScore}}
                <span class="covering-pick">
                    <img class="covering-icon" src="{{.GetHomeTeamIconURL}}" alt="{{.Home}}" onerror="this.style.display='none'">
                    <span class="covering-team-text">{{if eq $differential 0}}TIE{{else if gt $differential 0}}+{{$differential}}{{else}}{{$differential}}{{end}}</span>
                    <span class="covering-team-mobile">{{if eq $differential 0}}TIE{{else if gt $differential 0}}+{{$differential}}{{else}}{{$differential}}{{end}}</span>
                </span>
            {{else if eq $spreadResult "away-covered"}}
                {{$differential := minus .HomeScore .AwayScore}}
                <span class="covering-pick">
                    <img class="covering-icon" src="{{.GetAwayTeamIconURL}}" alt="{{.Away}}" onerror="this.style.display='none'">
                    <span class="covering-team-text">{{if eq $differential 0}}TIE{{else if gt $differential 0}}+{{$differential}}{{else}}{{$differential}}{{end}}</span>
                    <span class="covering-team-mobile">{{if eq $differential 0}}TIE{{else if gt $differential 0}}+{{$differential}}{{else}}{{$differential}}{{end}}</span>
                </span>
            {{else if eq $spreadResult "push"}}
                <span class="covering-pick push-pick">
                    <span class="covering-team-text">PUSH</span>
                    <span class="covering-team-mobile">PUSH</span>
                </span>
            {{end}}
        {{end}}
    </div>
    <div class="ou-result-column">
        {{if .HasOdds}}
            {{$totalPoints := add .HomeScore .AwayScore}}
            {{$totalPointsFloat := float64 $totalPoints}}
            {{if gt $totalPointsFloat .Odds.OU}}
                <span class="covering-pick ou-pick">
                    <img class="covering-icon" src="https://api.iconify.design/mdi/chevron-double-up.svg" alt="Over">
                    <span class="covering-ou-text">{{$totalPoints}}</span>
                    <span class="covering-ou-mobile">{{$totalPoints}}</span>
                </span>
            {{else if lt $totalPointsFloat .Odds.OU}}
                <span class="covering-pick ou-pick">
                    <img class="covering-icon" src="https://api.iconify.design/mdi/chevron-double-down.svg" alt="Under">
                    <span class="covering-ou-text">{{$totalPoints}}</span>
                    <span class="covering-ou-mobile">{{$totalPoints}}</span>
                </span>
            {{else}}
                <span class="covering-pick push-pick">
                    <span class="covering-ou-text">{{$totalPoints}}</span>
                    <span class="covering-ou-mobile">{{$totalPoints}}</span>
                </span>
            {{end}}
        {{end}}
    </div>
</div>
{{end}}

{{define "modern-daily-picks"}}
{{$dailyPickGroups := .DailyPickGroups}}
{{$games := .Games}}
{{$isCurrentUser := .IsCurrentUser}}
{{/* Iterate through each day's picks - they'll be ordered by game time within each day */}}
{{range $date, $dayPicks := $dailyPickGroups}}
{{if $dayPicks}}
{{/* Convert date to day name for display */}}
{{$dayName := getDayNameFromDate $date}}
<div class="daily-pick-group">
<div class="daily-pick-header">{{$dayName}}</div>
<div class="daily-picks-list">
{{range sortPicksByGameTime $dayPicks $games}}
{{template "unified-pick-item" dict "Pick" . "Games" $games "IsCurrentUser" $isCurrentUser}}
{{end}}
</div>
</div>
{{end}}
{{end}}
{{end}}


