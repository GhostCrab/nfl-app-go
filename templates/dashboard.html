<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{{.Title}}</title>
    <script>
        // Apply dark theme by default to match legacy
        (function() {
            const savedTheme = localStorage.getItem('theme') || 'dark';
            if (savedTheme === 'light') {
                document.documentElement.setAttribute('data-theme', 'light');
            }
        })();
    </script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@300;400;500;700&display=block" rel="stylesheet">
    <script src="https://unpkg.com/htmx.org@1.9.10"></script>
    <script src="https://unpkg.com/htmx.org@1.9.10/dist/ext/sse.js"></script>
    <link rel="stylesheet" href="/static/style.css">
</head>
<body>
    <!-- Navigation Bar - Exact Material Design mat-toolbar -->
    <mat-toolbar class="mat-toolbar">
        <a href="/" class="nav-brand">PC '25</a>
        <div class="nav-links">
            <a href="/" class="nav-link active">Dashboard</a>
            <a href="/analytics" class="nav-link">Statistics</a>
            <a href="/survivor" class="nav-link">Survivor</a>
        </div>
        <div class="flex-expand"></div>
        <div class="nav-controls">
            {{if .User}}
                <span class="user-info">{{.User.Name}}</span>
                <a href="/logout" class="logout-button">Logout</a>
            {{else}}
                <a href="/login" class="login-button">Login</a>
            {{end}}
            <button class="theme-toggle" id="theme-toggle">☀️</button>
        </div>
    </mat-toolbar>

    <!-- Dashboard Container - Exact legacy three-column layout -->
    <div class="dashboard-container" hx-ext="sse" sse-connect="/events">
        <div class="dashboard-content" id="dashboard-content">
            {{template "dashboard-content" .}}
        </div>

    <!-- Template for game grid that will be updated via SSE - Inline Grid Structure -->
    {{define "game-grid"}}
        <div class="games-list-container" sse-swap="gameUpdate">
            {{range .Games}}
                <div class="game-row inline-game {{.State}}" id="game-{{.ID}}">
                     
                    <!-- Away Team Section -->
                    <div class="team-section away">
                        <div class="team-name">
                            <img class="team-img" src="{{.GetAwayTeamIconURL}}" alt="{{.Away}}" 
                                 onerror="this.style.display='none'"/>
                            <div class="team-info">
                                <div class="team-abbr">{{.Away}}</div>
                                {{if .HasOdds}}
                                    <div class="team-spread">{{.FormatAwaySpread}}</div>
                                {{end}}
                            </div>
                            {{if ne .State "scheduled"}}
                                <span class="score-display">{{.AwayScore}}</span>
                            {{end}}
                        </div>
                    </div>

                    <!-- VS/@ separator -->
                    <div class="vs-section">@</div>

                    <!-- Home Team Section -->
                    <div class="team-section home">
                        <div class="team-name">
                            {{if ne .State "scheduled"}}
                                <span class="score-display">{{.HomeScore}}</span>
                            {{end}}
                            <img class="team-img" src="{{.GetHomeTeamIconURL}}" alt="{{.Home}}" 
                                 onerror="this.style.display='none'"/>
                            <div class="team-info">
                                <div class="team-abbr">{{.Home}}</div>
                                {{if .HasOdds}}
                                    <div class="team-spread">{{.FormatHomeSpread}}</div>
                                {{end}}
                            </div>
                        </div>
                    </div>

                    <!-- Over/Under Section -->
                    <div class="ou-section">
                        {{if .HasOdds}}
                            O/U {{.Odds.OU}}
                        {{else}}
                            -
                        {{end}}
                    </div>

                    <!-- Game Status Section -->
                    <div class="game-status-section">
                        {{if eq .State "scheduled"}}
                            <div class="game-time">{{.FormatGameTime}}</div>
                        {{else if eq .State "in_play"}}
                            <span class="live-indicator">LIVE</span>
                            <span class="game-time">
                                {{if .HasStatus}}
                                    Q{{.Quarter}} {{.GetGameClock}}
                                {{else}}
                                    Q{{.Quarter}}
                                {{end}}
                            </span>
                        {{else if eq .State "completed"}}
                            <span class="game-time">FINAL</span>
                            {{if and .HasOdds .IsCompleted}}
                                <span class="spread-result">
                                    {{if eq .SpreadResult "push"}}
                                        PUSH
                                    {{else if eq .SpreadResult "home-covered"}}
                                        {{.Home}} ✓
                                    {{else if eq .SpreadResult "away-covered"}}
                                        {{.Away}} ✓
                                    {{end}}
                                </span>
                            {{end}}
                        {{end}}
                    </div>
                </div>
                {{if eq .State "in_play"}}
                    <!-- Always visible game expansion -->
                    <div class="live-game-expansion">
                        <!-- Game Status and Possession -->
                        {{if .HasStatus}}
                            {{$possessionStr := .GetPossessionString}}
                            {{if ne $possessionStr ""}}
                                <span class="status-item">{{$possessionStr}}</span>
                                <span class="status-divider"> || </span>
                            {{end}}
                        {{end}}
                        
                        <!-- O/U Status with tracking -->
                        {{if .HasOdds}}
                            {{$currentTotal := add .HomeScore .AwayScore}}
                            {{$currentTotalFloat := float64 $currentTotal}}
                            {{$overUnder := .Odds.OU}}
                            {{if ge $currentTotalFloat $overUnder}}
                                <span class="status-item ou-current" style="color: #e74c3c; font-weight: bold;">OVER HIT ({{$currentTotal}}/{{$overUnder}})</span>
                            {{else}}
                                {{$needed := sub $overUnder $currentTotalFloat}}
                                {{if le $needed 7.0}}
                                    <span class="status-item ou-current" style="color: #ff9800; font-weight: bold;">{{ceil $needed}} needed for OVER ({{$currentTotal}}/{{$overUnder}})</span>
                                {{else}}
                                    {{/* Check if game is on track for over based on time progression */}}
                                    {{if .HasStatus}}
                                        {{$projectedTotal := projectFinalScore .HomeScore .AwayScore .Quarter .GetGameClock}}
                                        {{if ge $projectedTotal $overUnder}}
                                            <span class="status-item ou-current" style="color: #ff9800; font-weight: bold;">On track for OVER ({{$currentTotal}}/{{$overUnder}}, proj: {{printf "%.0f" $projectedTotal}})</span>
                                        {{else}}
                                            <span class="status-item ou-current">Total: {{$currentTotal}} (O/U {{$overUnder}})</span>
                                        {{end}}
                                    {{else}}
                                        <span class="status-item ou-current">Total: {{$currentTotal}} (O/U {{$overUnder}})</span>
                                    {{end}}
                                {{end}}
                            {{end}}
                        {{else}}
                            <span class="status-item no-odds">{{.AwayScore}} - {{.HomeScore}}</span>
                        {{end}}
                        
                        <!-- Red Zone Indicator -->
                        {{if .HasStatus}}
                            {{if .Status.IsRedZone}}
                                <span class="status-divider"> || </span>
                                <span class="status-item" style="color: #e74c3c; font-weight: bold;">RED ZONE</span>
                            {{end}}
                        {{end}}
                    </div>
                {{end}}
            {{end}}
        </div>
    {{end}}

    <!-- Dashboard Content Template (for HTMX partial updates) -->
    {{define "dashboard-content"}}
        <!-- Left Column: Pick Lists - Material Design Structure -->
        <div class="pick-flex-item">
            <!-- Unified rendering for all users (current user first, then others) -->
            {{if .UserPicks}}
                {{$currentUserName := ""}}
                {{if .User}}{{$currentUserName = .User.Name}}{{end}}
                
                <!-- Render current user first if logged in -->
                {{range .UserPicks}}
                    {{if eq .UserName $currentUserName}}
                        <fieldset class="user-picks-section">
                            <legend>MY PICKS</legend>
                            <div class="user-picks-content">

                            <!-- Bonus Thursday picks -->
                            {{if .BonusThursdayPicks}}
                                <div class="regular-picks-section">
                                    <div class="picks-category-header">BONUS THURSDAY</div>
                                    <div class="picks-list">
                                        {{range .BonusThursdayPicks}}
                                            {{template "unified-pick-item" dict "Pick" . "Games" $.Games "IsCurrentUser" true}}
                                        {{end}}
                                    </div>
                                </div>
                            {{end}}

                            <!-- Bonus Friday picks -->
                            {{if .BonusFridayPicks}}
                                <div class="regular-picks-section">
                                    <div class="picks-category-header">BONUS FRIDAY</div>
                                    <div class="picks-list">
                                        {{range .BonusFridayPicks}}
                                            {{template "unified-pick-item" dict "Pick" . "Games" $.Games "IsCurrentUser" true}}
                                        {{end}}
                                    </div>
                                </div>
                            {{end}}

                            <!-- Regular picks (filtered to exclude bonus picks) -->
                            {{if .Picks}}
                                {{$hasAnyBonusPicks := or .BonusThursdayPicks .BonusFridayPicks}}
                                {{if $hasAnyBonusPicks}}
                                    <div class="regular-picks-section">
                                        <div class="picks-category-header">REMAINING PICKS</div>
                                        <div class="picks-list">
                                            {{$userPicks := .}}
                                            {{range .Picks}}
                                                {{$currentPick := .}}
                                                {{$isBonus := false}}
                                                {{range $userPicks.BonusThursdayPicks}}{{if eq .GameID $currentPick.GameID}}{{$isBonus = true}}{{end}}{{end}}
                                                {{range $userPicks.BonusFridayPicks}}{{if eq .GameID $currentPick.GameID}}{{$isBonus = true}}{{end}}{{end}}
                                                {{if not $isBonus}}
                                                    {{template "unified-pick-item" dict "Pick" . "Games" $.Games "IsCurrentUser" true}}
                                                {{end}}
                                            {{end}}
                                        </div>
                                    </div>
                                {{else}}
                                    <div class="regular-picks-section">
                                        <div class="picks-category-header">REMAINING PICKS</div>
                                        <div class="picks-list">
                                            {{range .Picks}}
                                                {{template "unified-pick-item" dict "Pick" . "Games" $.Games "IsCurrentUser" true}}
                                            {{end}}
                                        </div>
                                    </div>
                                {{end}}
                            {{end}}
                            </div>
                        </fieldset>
                    {{end}}
                {{end}}

                <!-- Render other users -->
                {{range .UserPicks}}
                    {{if ne .UserName $currentUserName}}
                        <fieldset class="user-picks-section">
                            <legend>{{.UserName}}'S PICKS</legend>
                            <div class="user-picks-content">

                            <!-- Bonus Thursday picks -->
                            {{if .BonusThursdayPicks}}
                                <div class="regular-picks-section">
                                    <div class="picks-category-header">BONUS THURSDAY</div>
                                    <div class="picks-list">
                                        {{range .BonusThursdayPicks}}
                                            {{template "unified-pick-item" dict "Pick" . "Games" $.Games "IsCurrentUser" false}}
                                        {{end}}
                                    </div>
                                </div>
                            {{end}}

                            <!-- Bonus Friday picks -->
                            {{if .BonusFridayPicks}}
                                <div class="regular-picks-section">
                                    <div class="picks-category-header">BONUS FRIDAY</div>
                                    <div class="picks-list">
                                        {{range .BonusFridayPicks}}
                                            {{template "unified-pick-item" dict "Pick" . "Games" $.Games "IsCurrentUser" false}}
                                        {{end}}
                                    </div>
                                </div>
                            {{end}}

                            <!-- Regular picks (filtered to exclude bonus picks) -->
                            {{if .Picks}}
                                {{$hasAnyBonusPicks := or .BonusThursdayPicks .BonusFridayPicks}}
                                {{if $hasAnyBonusPicks}}
                                    <div class="regular-picks-section">
                                        <div class="picks-category-header">REMAINING PICKS</div>
                                        <div class="picks-list">
                                            {{$userPicks := .}}
                                            {{range .Picks}}
                                                {{$currentPick := .}}
                                                {{$isBonus := false}}
                                                {{range $userPicks.BonusThursdayPicks}}{{if eq .GameID $currentPick.GameID}}{{$isBonus = true}}{{end}}{{end}}
                                                {{range $userPicks.BonusFridayPicks}}{{if eq .GameID $currentPick.GameID}}{{$isBonus = true}}{{end}}{{end}}
                                                {{if not $isBonus}}
                                                    {{template "unified-pick-item" dict "Pick" . "Games" $.Games "IsCurrentUser" false}}
                                                {{end}}
                                            {{end}}
                                        </div>
                                    </div>
                                {{else}}
                                    <div class="regular-picks-section">
                                        <div class="picks-category-header">REMAINING PICKS</div>
                                        <div class="picks-list">
                                            {{range .Picks}}
                                                {{template "unified-pick-item" dict "Pick" . "Games" $.Games "IsCurrentUser" false}}
                                            {{end}}
                                        </div>
                                    </div>
                                {{end}}
                            {{end}}
                            </div>
                        </fieldset>
                    {{end}}
                {{end}}
            {{else}}
                <!-- No picks data available -->
                <fieldset class="user-picks-section mt-4">
                    <legend>My Picks</legend>
                    <div class="user-picks-content">
                        <div class="no-picks">Please log in to see picks</div>
                    </div>
                </fieldset>
            {{end}}
        </div>

        <!-- Center Column: Current Games - Material Design Structure -->
        <div class="game-flex-item">
            <!-- Week Selector with mat-form-field structure -->
            <div class="week-selector-container">
                <div class="form-field">
                    <label for="week-select" class="form-label">View Week</label>
                    <select id="week-select" name="week" class="week-select" 
                            hx-get="/" 
                            hx-target="#dashboard-content"
                            hx-include="[name='season']"
                            hx-trigger="change">
                        {{range .Weeks}}
                            <option value="{{.}}" {{if eq . $.CurrentWeek}}selected{{end}}>
                                Week {{.}}
                            </option>
                        {{end}}
                    </select>
                    <input type="hidden" name="season" value="{{.CurrentSeason}}">
                </div>
                <span class="keyboard-hint">
                    Use ← → arrow keys to navigate
                </span>
                {{if .User}}
                    <a href="/picker" class="update-picks-btn">
                        Update Picks
                    </a>
                {{end}}
            </div>

            <!-- Games Grid with inline structure -->
            <div class="games-container">
                <div class="section-header" id="games-header">CURRENT GAMES</div>
                {{template "game-grid" .}}
            </div>
        </div>

        <!-- Right Column: Club Scores - Material Design Structure -->
        <div class="score-flex-item">
            <div class="section-header">CLUB SCORE</div>
            <div class="club-scores">
                {{if .UserPicks}}
                    {{$sortedUsers := sortUsersByScore .UserPicks}}
                    {{range $sortedUsers}}
                        <div class="score-item">
                            <span class="user-name">{{.UserName}}</span>
                            <span class="user-score">
                                {{.Record.ParlayPoints}}
                                {{if .Record.WeeklyPoints}}
                                    <span class="weekly-gain">(+{{.Record.WeeklyPoints}})</span>
                                {{end}}
                            </span>
                        </div>
                    {{end}}
                {{else}}
                    {{range .Users}}
                        <div class="score-item">
                            <span class="user-name">{{.Name}}</span>
                            <span class="user-score">0</span>
                        </div>
                    {{end}}
                {{end}}
            </div>
        </div>
    {{end}}

    <!-- Unified Pick Item Template -->
    {{define "unified-pick-item"}}
        {{$pick := .Pick}}
        {{$games := .Games}}
        {{$isCurrentUser := .IsCurrentUser}}
        {{$game := findGameByID $games $pick.GameID}}
        <div class="pick-item {{getResultClass $pick $game}}">
            <div class="pick-matchup">
                {{if $game}}
                    <span class="matchup-text">
                        <img class="team-img-small" src="{{$game.GetAwayTeamIconURL}}" alt="{{$game.Away}}" onerror="this.style.display='none'"/>{{$game.Away}} @ <img class="team-img-small" src="{{$game.GetHomeTeamIconURL}}" alt="{{$game.Home}}" onerror="this.style.display='none'"/>{{$game.Home}}
                    </span>
                {{end}}
            </div>
            <div class="pick-details">
                {{if $pick.PickDescription}}
                    {{$cleanDesc := regexReplace $pick.PickDescription "\\s*\\([^)]*\\)\\s*" ""}}
                    {{$teamAbbr := getPickTeamAbbr $pick $game $cleanDesc}}
                    {{$teamIcon := getPickTeamIcon $teamAbbr}}
                    {{$pickValue := getPickValue $pick $game $cleanDesc}}
                    <img class="team-img-small" src="{{$teamIcon}}" alt="{{$teamAbbr}}" onerror="this.style.display='none'"/>
                    <span class="picked-team">{{$teamAbbr}}</span>
                    <span class="pick-spread">{{$pickValue}}</span>
                {{else}}
                    <span class="pick-type">{{$pick.PickType}}</span>
                {{end}}
            </div>
        </div>
        {{if and $game (eq $game.State "in_play")}}
            <div class="live-pick-expansion">
                <span class="game-score">{{$game.Away}} {{$game.AwayScore}} - {{$game.HomeScore}} {{$game.Home}}</span>
                <span class="game-clock">{{$game.GetGameClock}} {{if eq $game.Quarter 5}}OT{{else if eq $game.Quarter 6}}2OT{{else}}Q{{$game.Quarter}}{{end}}</span>
                {{if $game.HasStatus}}
                    {{$possessionStr := $game.GetPossessionString}}
                    {{if ne $possessionStr ""}}<span class="game-possession">{{$possessionStr}}</span>{{end}}
                {{end}}
                {{if isOverUnder $pick}}
                    {{if $game.HasOdds}}
                        {{$currentTotal := add $game.HomeScore $game.AwayScore}}
                        {{$currentTotalFloat := float64 $currentTotal}}
                        {{$overUnder := $game.Odds.OU}}
                        {{if $game.HasStatus}}
                            {{$projectedTotal := projectFinalScore $game.HomeScore $game.AwayScore $game.Quarter $game.GetGameClock}}
                            {{if ge $projectedTotal $overUnder}}
                                {{if contains $pick.PickDescription "Over"}}
                                    <span class="pick-winning">{{$currentTotal}}/{{$overUnder}} OVER PACE</span>
                                {{else}}
                                    <span class="pick-losing">{{$currentTotal}}/{{$overUnder}} OVER PACE</span>
                                {{end}}
                            {{else}}
                                {{if contains $pick.PickDescription "Over"}}
                                    <span class="pick-losing">{{$currentTotal}}/{{$overUnder}} UNDER PACE</span>
                                {{else}}
                                    <span class="pick-winning">{{$currentTotal}}/{{$overUnder}} UNDER PACE</span>
                                {{end}}
                            {{end}}
                        {{else}}
                            <span class="pick-neutral">{{$currentTotal}}/{{$overUnder}}</span>
                        {{end}}
                    {{end}}
                {{else if isSpreadPick $pick}}
                    {{$coverStatus := isPickedTeamCovering $pick $game}}
                    {{$teamAbbr := ""}}
                    {{$differential := 0}}
                    {{if and (contains $pick.TeamName $game.Home) (ne $game.Home "")}}
                        {{$teamAbbr = $game.Home}}
                        {{$differential = minus $game.AwayScore $game.HomeScore}}
                    {{else if and (contains $pick.TeamName $game.Away) (ne $game.Away "")}}
                        {{$teamAbbr = $game.Away}}
                        {{$differential = minus $game.HomeScore $game.AwayScore}}
                    {{else}}
                        {{$teamAbbr = $pick.TeamName}}
                        {{$differential = minus $game.HomeScore $game.AwayScore}}
                    {{end}}
                    {{if eq $coverStatus "covering"}}
                        <span class="pick-winning">{{$teamAbbr}} {{if eq $differential 0}}TIE{{else if gt $differential 0}}+{{$differential}}{{else}}{{$differential}}{{end}}</span>
                    {{else if eq $coverStatus "push"}}
                        <span class="pick-neutral">{{$teamAbbr}} PUSH</span>
                    {{else if eq $coverStatus "not-covering"}}
                        <span class="pick-losing">{{$teamAbbr}} {{if eq $differential 0}}TIE{{else if gt $differential 0}}+{{$differential}}{{else}}{{$differential}}{{end}}</span>
                    {{else}}
                        <span class="pick-losing">{{$teamAbbr}} {{if eq $differential 0}}TIE{{else if gt $differential 0}}+{{$differential}}{{else}}{{$differential}}{{end}}</span>
                    {{end}}
                {{else}}
                    <span class="pick-neutral">{{$game.AwayScore}} - {{$game.HomeScore}}</span>
                {{end}}
            </div>
        {{end}}
    {{end}}

    <script>
        // Initialize global navigation state
        window.currentWeek = {{.CurrentWeek}};
        window.currentSeason = {{.CurrentSeason}};
        
        // Minimal JavaScript for theme toggle
        document.getElementById('theme-toggle').addEventListener('click', function() {
            const html = document.documentElement;
            const currentTheme = html.getAttribute('data-theme');
            const newTheme = currentTheme === 'light' ? 'dark' : 'light';
            
            html.setAttribute('data-theme', newTheme);
            localStorage.setItem('theme', newTheme);
        });
        
        // Keyboard navigation for weeks using HTMX
        document.addEventListener('keydown', function(e) {
            // Don't interfere with form inputs
            if (e.target.tagName === 'INPUT' || e.target.tagName === 'TEXTAREA' || e.target.tagName === 'SELECT') {
                return;
            }
            
            // Read current values from JavaScript variables that get updated via HTMX
            const currentWeek = window.currentWeek || {{.CurrentWeek}};
            const currentSeason = window.currentSeason || {{.CurrentSeason}};
            let newWeek = currentWeek;
            let newSeason = currentSeason;
            
            if (e.key === 'ArrowLeft') {
                e.preventDefault();
                if (currentWeek > 1) {
                    newWeek = currentWeek - 1;
                } else if (currentSeason > 2023) { // Don't go back past 2023
                    newWeek = 18;
                    newSeason = currentSeason - 1;
                }
                // If we're at 2023 Week 1, don't allow going further back
            } else if (e.key === 'ArrowRight') {
                e.preventDefault();
                if (currentWeek < 18) {
                    newWeek = currentWeek + 1;
                } else if (currentSeason < {{.CurrentSeason}}) { // Don't go past current season
                    newWeek = 1;
                    newSeason = currentSeason + 1;
                }
                // If we're at current season Week 18, don't allow going further forward
            }
            
            // Navigate if week or season changed using HTMX
            if (newWeek !== currentWeek || newSeason !== currentSeason) {
                // Update global variables
                window.currentWeek = newWeek;
                window.currentSeason = newSeason;
                // Use HTMX to fetch new content
                htmx.ajax('GET', '/?week=' + newWeek + '&season=' + newSeason, {
                    target: '#dashboard-content',
                    swap: 'innerHTML'
                });
                
                // Update URL without reload
                const url = new URL(window.location);
                url.searchParams.set('week', newWeek);
                url.searchParams.set('season', newSeason);
                history.pushState({week: newWeek, season: newSeason}, '', url.toString());
            }
        });
    </script>
</body>
</html>