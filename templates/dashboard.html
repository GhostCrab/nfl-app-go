<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{{.Title}}</title>
    <script>
        // Apply dark theme by default to match legacy
        (function() {
            const savedTheme = localStorage.getItem('theme') || 'dark';
            if (savedTheme === 'light') {
                document.documentElement.setAttribute('data-theme', 'light');
            }
        })();
    </script>
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@300;400;500;700&display=swap" rel="stylesheet">
    <script src="https://unpkg.com/htmx.org@1.9.10"></script>
    <script src="https://unpkg.com/htmx.org@1.9.10/dist/ext/sse.js"></script>
    <link rel="stylesheet" href="/static/style.css">
</head>
<body>
    <!-- Navigation Bar - Exact Material Design mat-toolbar -->
    <mat-toolbar class="mat-toolbar">
        <a href="/" class="nav-brand">PC '25</a>
        <div class="nav-links">
            <a href="/" class="nav-link active">Dashboard</a>
            <a href="/analytics" class="nav-link">Statistics</a>
            <a href="/survivor" class="nav-link">Survivor</a>
        </div>
        <div class="flex-expand"></div>
        <div class="nav-controls">
            {{if .User}}
                <span class="user-info">{{.User.Name}}</span>
                <a href="/logout" class="logout-button">Logout</a>
            {{else}}
                <a href="/login" class="login-button">Login</a>
            {{end}}
            <button class="theme-toggle" onclick="toggleTheme()">☀️</button>
        </div>
    </mat-toolbar>

    <!-- Dashboard Container - Exact legacy three-column layout -->
    <div class="dashboard-container">
        <div class="dashboard-content">
            <!-- Left Column: All Users' Picks -->
            <div class="pick-flex-item" id="all-picks-container">
                <!-- This will be populated by JavaScript with all users' picks organized by day -->
                {{if .UserPicks}}
                    {{range .UserPicks}}
                        <div class="user-picks-section" data-user-id="{{.UserID}}" data-user-name="{{.UserName}}">
                            <h2 class="user-picks-header">{{.UserName}} PICKS</h2>
                            
                            <!-- Thursday picks section -->
                            <fieldset class="bonus-picks-section thursday-section" data-day="thursday">
                                <legend>BONUS THURSDAY</legend>
                                <div class="pick-count thursday-count" style="display: none;">
                                    <h3>THURSDAY PICKS: <span class="count">0</span></h3>
                                </div>
                                <div class="picks-list thursday-picks">
                                    <!-- Populated by JavaScript -->
                                </div>
                            </fieldset>
                            
                            <!-- Friday picks section -->
                            <fieldset class="bonus-picks-section friday-section" data-day="friday">
                                <legend>BONUS FRIDAY</legend>
                                <div class="pick-count friday-count" style="display: none;">
                                    <h3>FRIDAY PICKS: <span class="count">0</span></h3>
                                </div>
                                <div class="picks-list friday-picks">
                                    <!-- Populated by JavaScript -->
                                </div>
                            </fieldset>
                            
                            <!-- Saturday picks section -->
                            <div class="pick-count saturday-count" style="display: none;">
                                <h3>SATURDAY PICKS: <span class="count">0</span></h3>
                            </div>
                            <div class="picks-list saturday-picks" data-day="saturday">
                                <!-- Populated by JavaScript -->
                            </div>
                            
                            <!-- Sunday/Monday picks section -->
                            <div class="pick-count other-count" style="display: none;">
                                <h3>SUN/MON PICKS: <span class="count">0</span></h3>
                            </div>
                            <div class="picks-list other-picks" data-day="other">
                                <!-- Populated by JavaScript -->
                            </div>
                        </div>
                    {{end}}
                {{else}}
                    <!-- No picks available -->
                    <div class="no-picks-available">
                        <p>No picks available for this week.</p>
                        {{if .User}}
                            <p><a href="/picker">Make your picks here</a></p>
                        {{else}}
                            <p>Please log in to see picks.</p>
                        {{end}}
                    </div>
                {{end}}
            </div>

            <!-- Center Column: Current Games - Material Design Structure -->
            <div class="game-flex-item">
                <!-- Week Selector with mat-form-field structure -->
                <div class="week-selector-container">
                    <div class="form-field">
                        <label for="week-select" class="form-label">View Week</label>
                        <select id="week-select" class="week-select" onchange="selectWeek(this.value)">
                            {{range .Weeks}}
                                <option value="{{.}}" {{if eq . $.CurrentWeek}}selected{{end}}>
                                    Week {{.}}
                                </option>
                            {{end}}
                        </select>
                    </div>
                    <span class="keyboard-hint">
                        Use ← → arrow keys to navigate
                    </span>
                    {{if .User}}
                        <button class="update-picks-btn" onclick="window.location.href='/picker'">
                            Update Picks
                        </button>
                    {{end}}
                </div>

                <!-- Games Grid with mat-grid-list structure -->
                <div class="games-container" hx-ext="sse" sse-connect="/events">
                    <div class="section-header" id="games-header">CURRENT GAMES</div>
                    <div class="games-grid">
                        {{template "game-grid" .}}
                    </div>
                </div>
            </div>

            <!-- Right Column: Club Scores - Material Design Structure -->
            <div class="score-flex-item">
                <div class="section-header">CLUB SCORE</div>
                <div class="club-scores">
                    {{if .UserPicks}}
                        {{range .UserPicks}}
                            <div class="score-item">
                                <span class="user-name">{{.UserName}}</span>
                                <span class="user-score">{{.Record.String}}</span>
                            </div>
                        {{end}}
                    {{else}}
                        {{range .Users}}
                            <div class="score-item">
                                <span class="user-name">{{.Name}}</span>
                                <span class="user-score">0-0-0</span>
                            </div>
                        {{end}}
                    {{end}}
                </div>

                <!-- Week Summary -->
                <div class="week-summary mt-4">
                    <div class="section-header">Week Summary</div>
                    <div class="summary-stats">
                        <div class="stat-item">
                            <span>Games Played:</span>
                            <span>{{len .Games}}</span>
                        </div>
                        <div class="stat-item">
                            <span>Games Remaining:</span>
                            <span id="games-remaining">0</span>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Template for game grid that will be updated via SSE - Mat Grid Tile Structure -->
    {{define "game-grid"}}
        <mat-grid-list class="mat-grid-list" cols="21" sse-swap="gameUpdate">
            {{range .Games}}
                <mat-grid-tile class="game-card {{.State}}" id="game-{{.ID}}" colspan="21" rowspan="1">
                    <!-- Away Team - colspan equivalent for flex layout -->
                    <div class="team-section away" style="flex: 5;">
                        <div class="team-name">
                            <img class="team-img" src="{{.GetAwayTeamIconURL}}" alt="{{.Away}}" 
                                 onerror="this.style.display='none'"/>
                            <div>
                                <div>{{.Away}}</div>
                                {{if .HasOdds}}
                                    <div class="team-spread">{{.FormatAwaySpread}}</div>
                                {{end}}
                            </div>
                            {{if ne .State "scheduled"}}
                                <span class="score-display">{{.AwayScore}}</span>
                            {{end}}
                        </div>
                    </div>

                    <!-- VS Separator - colspan equivalent -->
                    <div class="vs-separator" style="flex: 2;">@</div>

                    <!-- Home Team - colspan equivalent -->
                    <div class="team-section home" style="flex: 5;">
                        <div class="team-name">
                            {{if ne .State "scheduled"}}
                                <span class="score-display">{{.HomeScore}}</span>
                            {{end}}
                            <img class="team-img" src="{{.GetHomeTeamIconURL}}" alt="{{.Home}}" 
                                 onerror="this.style.display='none'"/>
                            <div>
                                <div>{{.Home}}</div>
                                {{if .HasOdds}}
                                    <div class="team-spread">{{.FormatHomeSpread}}</div>
                                {{end}}
                            </div>
                        </div>
                    </div>

                    <!-- Over/Under - colspan equivalent -->
                    <div class="ou-section" style="flex: 3;">
                        {{if .HasOdds}}
                            O/U {{.Odds.OU}}
                        {{else}}
                            -
                        {{end}}
                    </div>

                    <!-- Game Status - colspan equivalent -->
                    <div class="game-status-section" style="flex: 6;">
                        {{if eq .State "scheduled"}}
                            <div class="game-week">Week {{.Week}}</div>
                            <div class="game-time">{{.FormatGameTime}}</div>
                        {{else if eq .State "in_play"}}
                            <div class="live-indicator">LIVE</div>
                            <div class="game-time">Q{{.Quarter}}</div>
                        {{else if eq .State "completed"}}
                            <div class="game-time">FINAL</div>
                            {{if and .HasOdds .IsCompleted}}
                                <div class="spread-result">
                                    {{if eq .SpreadResult "push"}}
                                        PUSH
                                    {{else if eq .SpreadResult "home-covered"}}
                                        {{.Home}} ✓
                                    {{else if eq .SpreadResult "away-covered"}}
                                        {{.Away}} ✓
                                    {{end}}
                                </div>
                            {{end}}
                        {{end}}
                    </div>
                </mat-grid-tile>
            {{end}}
        </mat-grid-list>
    {{end}}

    <script>
        function toggleTheme() {
            const html = document.documentElement;
            const button = document.querySelector('.theme-toggle');
            
            if (html.getAttribute('data-theme') === 'light') {
                html.removeAttribute('data-theme');
                button.textContent = '☀️';
                localStorage.setItem('theme', 'dark');
            } else {
                html.setAttribute('data-theme', 'light');
                button.textContent = '🌙';
                localStorage.setItem('theme', 'light');
            }
        }

        function selectWeek(week) {
            // Use unified navigation system (same as arrow keys)
            const weekNum = parseInt(week);
            navigateToWeek(weekNum, currentDisplayedSeason);
        }

        // Unified navigation function for both dropdown and arrow keys
        async function navigateToWeek(week, season) {
            console.log(`navigateToWeek called: week=${week}, season=${season}, current=(${currentDisplayedWeek},${currentDisplayedSeason}), isLoading=${isLoading}`);
            
            if (isLoading) {
                console.log('navigateToWeek: Already loading, skipping');
                return;
            }
            
            if (week === currentDisplayedWeek && season === currentDisplayedSeason) {
                console.log('navigateToWeek: Already at this week/season, but proceeding anyway for initial load');
                // Don't return early on first load, we need to load the data
            }
            
            // Update current displayed values
            currentDisplayedWeek = week;
            currentDisplayedSeason = season;
            
            // Update dropdown selection
            const weekSelect = document.getElementById('week-select');
            if (weekSelect) {
                weekSelect.value = week;
            }
            
            // Update URL without page reload
            const url = new URL(window.location);
            url.searchParams.set('week', week);
            if (season !== 2025) {
                url.searchParams.set('season', season);
            } else {
                url.searchParams.delete('season');
            }
            history.pushState({week, season}, '', url.toString());
            
            // Check cache first
            if (!seasonCache[season]) seasonCache[season] = {};
            
            let data = seasonCache[season][week];
            
            if (!data) {
                // Load from server
                data = await loadDashboardData(week, season);
                if (data && typeof data === 'object' && data.userPicks) {
                    console.log(`Caching data for ${season} Week ${week}, type:`, typeof data);
                    seasonCache[season][week] = data;
                } else {
                    console.warn(`Not caching invalid data for ${season} Week ${week}, type:`, typeof data);
                }
            } else {
                console.log(`Using cached data for ${season} Week ${week}, type:`, typeof data);
            }
            
            if (data) {
                console.log(`About to call updateDashboardDisplay with data type:`, typeof data);
                updateDashboardDisplay(data);
            }
        }

        // Navigation variables with caching
        let currentDisplayedWeek = {{.CurrentWeek}};
        let currentDisplayedSeason = {{.CurrentSeason}}; // Use server-provided season
        const MIN_SEASON = 2023;
        const MAX_SEASON = 2025;
        
        // Initial server-rendered data (using manual JSON encoding)
        let initialGamesData = JSON.parse('{{.GamesJSON}}');
        let initialUserPicksData = JSON.parse('{{.UserPicksJSON}}');
        let initialUserData = {{if .User}}JSON.parse('{{.UserJSON}}'){{else}}null{{end}};
        
        // Cache for storing game data by season and week
        let seasonCache = {};
        let isLoading = false;
        

        // Fast AJAX navigation for arrow keys - loads complete dashboard data
        async function loadDashboardData(week, season) {
            if (isLoading) return null;
            
            const url = `/api/dashboard?week=${week}&season=${season}`;
            
            try {
                isLoading = true;
                const response = await fetch(url);
                if (!response.ok) throw new Error(`HTTP ${response.status}`);
                const data = await response.json();
                return data;
            } catch (error) {
                console.error('Failed to load dashboard data:', error);
                return null;
            } finally {
                isLoading = false;
            }
        }

        // Update the dashboard display with new data
        async function updateDashboardDisplay(data) {
            if (!data) {
                console.warn('No data provided to updateDashboardDisplay');
                return;
            }
            
            // Check if data is HTML string instead of JSON object
            if (typeof data === 'string') {
                console.error('ERROR: updateDashboardDisplay received HTML string instead of JSON object:', data.substring(0, 200));
                console.error('Stack trace:', new Error().stack);
                return;
            }
            
            console.log('updateDashboardDisplay received data:', data);
            const { games, userPicks, user, currentWeek: week, season } = data;
            console.log('Extracted userPicks:', userPicks);
            console.log('Extracted user:', user);
            console.log('Extracted games:', games);
            
            // Update games grid using the existing games API (it's fast)
            await updateGamesGrid(week, season);
            
            // Update picks display with client-side rendering, passing games data
            updatePicksDisplay(userPicks, user, games, week, season);
            
            // Update header
            const gamesHeader = document.getElementById('games-header');
            if (gamesHeader) {
                if (season === 2025) {
                    gamesHeader.textContent = `Week ${week} Games`;
                } else {
                    gamesHeader.textContent = `Week ${week} Games (${season})`;
                }
            }
            
            // Update URL without reload
            const url = new URL(window.location);
            url.searchParams.set('week', week);
            if (season !== 2025) {
                url.searchParams.set('season', season);
            } else {
                url.searchParams.delete('season');
            }
            history.pushState({week, season}, '', url.toString());
            
            // Update current displayed values
            currentDisplayedWeek = week;
            currentDisplayedSeason = season;
            
            // Update dropdown selection
            const weekSelect = document.getElementById('week-select');
            if (weekSelect) {
                weekSelect.value = week;
            }
        }

        // Update games grid using existing games API
        async function updateGamesGrid(week, season) {
            try {
                const response = await fetch(`/api/games?week=${week}&season=${season}`);
                if (response.ok) {
                    const html = await response.text();
                    const gamesGrid = document.querySelector('.games-grid');
                    if (gamesGrid) {
                        gamesGrid.innerHTML = html;
                    }
                }
            } catch (error) {
                console.error('Failed to update games grid:', error);
            }
        }

        // Helper function to map pick results to CSS classes (matches Go GetResultClass method)
        function getPickResultClass(result) {
            switch (result) {
                case 'win':
                    return 'green-pick-class';
                case 'loss':
                    return 'red-pick-class';
                case 'push':
                    return 'yellow-pick-class';
                default: // pending or any other state
                    return 'pick-class';
            }
        }

        // Helper function to get game day from date
        function getGameDay(gameDate) {
            const date = new Date(gameDate);
            const dayOfWeek = date.getDay(); // 0 = Sunday, 1 = Monday, etc.
            
            switch (dayOfWeek) {
                case 4: return 'thursday';   // Thursday
                case 5: return 'friday';     // Friday
                case 6: return 'saturday';   // Saturday
                default: return 'other';     // Sunday (0), Monday (1), other days
            }
        }

        // Helper function to organize picks by game day
        function organizePicksByDay(picks, games) {
            const organized = {
                thursday: [],
                friday: [],
                saturday: [],
                other: []
            };
            
            picks.forEach(pick => {
                // Find the game for this pick to get the date
                const game = games.find(g => g.id === pick.game_id);
                if (game && game.date) {
                    const day = getGameDay(game.date);
                    organized[day].push(pick);
                } else {
                    // If we can't find the game, default to "other"
                    organized.other.push(pick);
                }
            });
            
            return organized;
        }

        // Render a single pick using original styling
        function renderPickItem(pick, games) {
            const game = games.find(g => g.id === pick.game_id);
            
            return `<div class="pick-item ${getPickResultClass(pick.result)}">
                <span class="pick-info">${pick.pick_description || 'Game ' + pick.game_id + ' - Team ' + pick.team_id + ' (' + pick.pick_type + ')'}</span>
                <span class="pick-result">${pick.result}</span>
            </div>`;
        }

        // Main function to render all users' picks organized by day (similar to Angular app)
        function updatePicksDisplay(userPicks, currentUser, games = [], week = null, season = null) {
            console.log('Updating picks display:', { userPicks, currentUser, games });
            
            // Check if userPicks is valid
            if (!userPicks || !Array.isArray(userPicks)) {
                console.warn('Invalid userPicks data:', userPicks);
                userPicks = []; // Default to empty array
            }

            // Use the passed week/season or fall back to current displayed values
            const displayWeek = week !== null ? week : currentDisplayedWeek;
            const displaySeason = season !== null ? season : currentDisplayedSeason;

            // Get games data for organizing by day
            if (!games || games.length === 0) {
                // Use initial server-rendered data if available and matches current display
                if (initialGamesData && initialGamesData.length > 0 && 
                    displayWeek === currentDisplayedWeek && displaySeason === currentDisplayedSeason) {
                    games = initialGamesData;
                } else {
                    // Fetch games data if not provided
                    loadGamesData(currentDisplayedWeek, currentDisplayedSeason).then(gamesData => {
                        updatePicksDisplay(userPicks, currentUser, gamesData, displayWeek, displaySeason);
                    });
                    return;
                }
            }

            // Hide/show bonus sections for all users based on current week and season rules
            const allUserSections = document.querySelectorAll('.user-picks-section');
            allUserSections.forEach(userSection => {
                const thursdaySection = userSection.querySelector('.thursday-section');
                const fridaySection = userSection.querySelector('.friday-section');
                
                if (thursdaySection) {
                    thursdaySection.style.display = shouldShowBonusDay('thursday', displayWeek, displaySeason) ? 'block' : 'none';
                }
                if (fridaySection) {
                    fridaySection.style.display = shouldShowBonusDay('friday', displayWeek, displaySeason) ? 'block' : 'none';
                }
            });

            // Update each user's picks section
            userPicks.forEach(userPickData => {
                const userSection = document.querySelector(`.user-picks-section[data-user-id="${userPickData.user_id}"]`);
                if (!userSection) return;

                const picks = userPickData.picks || [];
                const organizedPicks = organizePicksByDay(picks, games);

                // Update Thursday picks
                updateDaySection(userSection, 'thursday', organizedPicks.thursday, games, displayWeek, displaySeason);
                // Update Friday picks  
                updateDaySection(userSection, 'friday', organizedPicks.friday, games, displayWeek, displaySeason);
                // Update Saturday picks
                updateDaySection(userSection, 'saturday', organizedPicks.saturday, games, displayWeek, displaySeason);
                // Update other picks (Sun/Mon)
                updateDaySection(userSection, 'other', organizedPicks.other, games, displayWeek, displaySeason);
            });

            // Update club scores with season points and (+#) indicators
            const clubScores = document.querySelector('.club-scores');
            if (clubScores && userPicks && Array.isArray(userPicks)) {
                clubScores.innerHTML = userPicks.map(up => {
                    const seasonPoints = up.season_points || 0;
                    const weekPoints = up.week_points || 0;
                    const weekIndicator = weekPoints > 0 ? ` (+${weekPoints})` : '';
                    
                    return `<div class="score-item">
                        <span class="user-name">${up.user_name || 'Unknown'}</span>
                        <span class="user-score">${seasonPoints}${weekIndicator}</span>
                    </div>`;
                }).join('');
            }
        }

        // Helper function to check if a game has started (for hiding future picks)
        function gameHasStarted(gameDate) {
            const now = new Date();
            const gameTime = new Date(gameDate);
            return gameTime <= now;
        }

        // Helper function to calculate Thanksgiving week for a given season
        function getThanksgivingWeek(season) {
            // Known Thanksgiving weeks for validation
            const knownThanksgivingWeeks = {
                2023: 12, // Thanksgiving was Nov 23, 2023
                2024: 13, // Thanksgiving was Nov 28, 2024
                2025: 13  // Thanksgiving is Nov 27, 2025
            };
            
            // Use known values if available
            if (knownThanksgivingWeeks[season]) {
                return knownThanksgivingWeeks[season];
            }
            
            // For unknown years, calculate based on typical NFL schedule
            // Calculate Thanksgiving date (4th Thursday of November)
            const november1 = new Date(season, 10, 1); // November 1st
            const firstThursday = new Date(november1);
            
            // Find first Thursday of November
            while (firstThursday.getDay() !== 4) { // 4 = Thursday
                firstThursday.setDate(firstThursday.getDate() + 1);
            }
            
            // 4th Thursday is 21 days later
            const thanksgiving = new Date(firstThursday);
            thanksgiving.setDate(firstThursday.getDate() + 21);
            
            // NFL typically starts the Thursday after Labor Day (first Monday of September)
            // Labor Day is first Monday of September
            const september1 = new Date(season, 8, 1); // September 1st
            const laborDay = new Date(september1);
            while (laborDay.getDay() !== 1) { // Find first Monday
                laborDay.setDate(laborDay.getDate() + 1);
            }
            
            // NFL season typically starts the Thursday after Labor Day
            const nflStart = new Date(laborDay);
            nflStart.setDate(laborDay.getDate() + 3); // Thursday after Monday
            
            // Calculate weeks between season start and Thanksgiving
            const timeDiff = thanksgiving.getTime() - nflStart.getTime();
            const daysDiff = Math.floor(timeDiff / (24 * 60 * 60 * 1000));
            const weeksDiff = Math.floor(daysDiff / 7);
            
            // NFL Week 1 starts on the season start date
            const thanksgivingWeek = weeksDiff + 1;
            
            // Clamp to reasonable range
            return Math.max(1, Math.min(18, thanksgivingWeek));
        }

        // Helper function to check if current week has bonus games
        function hasBonusGames(week, season = null) {
            // Use current displayed season if not provided
            const checkSeason = season !== null ? season : currentDisplayedSeason;
            const thanksgivingWeek = getThanksgivingWeek(checkSeason);
            
            // Bonus week rules evolved over time:
            // 2023: Only opening Thursday and Thanksgiving Thursday were bonus weeks
            // 2024: Added Thanksgiving Friday as bonus week (Thu+Fri for both weeks)  
            // 2025: Added opening Friday as bonus week (Thu+Fri for both weeks)
            
            const isOpeningWeek = week === 1;
            const isThanksgivingWeek = week === thanksgivingWeek;
            
            return isOpeningWeek || isThanksgivingWeek;
        }

        // Helper function to check if a specific day should show bonus section for a given week/season
        function shouldShowBonusDay(day, week, season = null) {
            const checkSeason = season !== null ? season : currentDisplayedSeason;
            const thanksgivingWeek = getThanksgivingWeek(checkSeason);
            
            const isOpeningWeek = week === 1;
            const isThanksgivingWeek = week === thanksgivingWeek;
            
            if (day === 'thursday') {
                // Thursday bonus games: all seasons for both opening and thanksgiving weeks
                return isOpeningWeek || isThanksgivingWeek;
            } else if (day === 'friday') {
                if (checkSeason >= 2025) {
                    // 2025+: Friday bonus for both opening week and thanksgiving week
                    return isOpeningWeek || isThanksgivingWeek;
                } else if (checkSeason >= 2024) {
                    // 2024: Friday bonus only for thanksgiving week
                    return isThanksgivingWeek;
                } else {
                    // 2023: No Friday bonus games
                    return false;
                }
            }
            
            return false;
        }

        // Helper function to update a specific day section for a user
        function updateDaySection(userSection, day, picks, games, week = null, season = null) {
            const dayMapping = {
                'thursday': { selector: '.thursday-picks', countSelector: '.thursday-count', sectionSelector: '.thursday-section' },
                'friday': { selector: '.friday-picks', countSelector: '.friday-count', sectionSelector: '.friday-section' },
                'saturday': { selector: '.saturday-picks', countSelector: '.saturday-count' },
                'other': { selector: '.other-picks', countSelector: '.other-count' }
            };

            const config = dayMapping[day];
            if (!config) return;

            const picksContainer = userSection.querySelector(config.selector);
            const countContainer = userSection.querySelector(config.countSelector);
            const sectionContainer = config.sectionSelector ? userSection.querySelector(config.sectionSelector) : null;
            
            // For Thursday and Friday, check if this specific day should show bonus section
            if ((day === 'thursday' || day === 'friday') && sectionContainer) {
                const checkWeek = week !== null ? week : currentDisplayedWeek;
                const checkSeason = season !== null ? season : currentDisplayedSeason;
                if (!shouldShowBonusDay(day, checkWeek, checkSeason)) {
                    // Hide the bonus section if this day isn't a bonus day for this season/week
                    sectionContainer.style.display = 'none';
                    return;
                } else {
                    // Show the bonus section if this day is a bonus day
                    sectionContainer.style.display = 'block';
                }
            }
            
            if (picks && picks.length > 0) {
                // Separate picks into visible and hidden based on game start times
                const visiblePicks = [];
                const hiddenPicks = [];
                
                picks.forEach(pick => {
                    const game = games.find(g => g.id === pick.game_id);
                    if (game && game.date && !gameHasStarted(game.date)) {
                        hiddenPicks.push(pick);
                    } else {
                        visiblePicks.push(pick);
                    }
                });

                if (visiblePicks.length > 0) {
                    // Show actual picks for games that have started
                    picksContainer.innerHTML = visiblePicks.map(pick => renderPickItem(pick, games)).join('');
                    if (countContainer) countContainer.style.display = 'none';
                } else if (hiddenPicks.length > 0) {
                    // Show pick count for hidden picks (games haven't started)
                    picksContainer.innerHTML = '';
                    const countSpan = countContainer.querySelector('.count');
                    if (countSpan) countSpan.textContent = hiddenPicks.length.toString();
                    if (countContainer) countContainer.style.display = 'block';
                } else {
                    // No picks at all
                    picksContainer.innerHTML = '';
                    if (countContainer) countContainer.style.display = 'none';
                }
            } else if (countContainer) {
                // No picks for this day
                picksContainer.innerHTML = '';
                const countSpan = countContainer.querySelector('.count');
                if (countSpan) countSpan.textContent = '0';
                countContainer.style.display = 'none';
            }
        }

        // Helper function to load games data
        async function loadGamesData(week, season) {
            try {
                const response = await fetch(`/api/dashboard?week=${week}&season=${season}`);
                if (response.ok) {
                    const data = await response.json();
                    return data.games || [];
                }
            } catch (error) {
                console.error('Failed to load games data:', error);
            }
            return [];
        }

        // Fast keyboard navigation with AJAX caching
        async function handleKeyboardNavigation(event) {
            // Only handle arrow keys when not typing in an input field
            if (event.target.tagName === 'INPUT' || event.target.tagName === 'TEXTAREA' || isLoading) {
                return;
            }
            
            let newWeek = currentDisplayedWeek;
            let newSeason = currentDisplayedSeason;
            
            if (event.key === 'ArrowLeft') {
                if (currentDisplayedWeek > 1) {
                    newWeek = currentDisplayedWeek - 1;
                } else if (currentDisplayedSeason > MIN_SEASON) {
                    newWeek = 18;
                    newSeason = currentDisplayedSeason - 1;
                }
            } else if (event.key === 'ArrowRight') {
                if (currentDisplayedWeek < 18) {
                    newWeek = currentDisplayedWeek + 1;
                } else if (currentDisplayedSeason < MAX_SEASON) {
                    newWeek = 1;
                    newSeason = currentDisplayedSeason + 1;
                }
            } else {
                return; // Not an arrow key
            }
            
            if (newWeek !== currentDisplayedWeek || newSeason !== currentDisplayedSeason) {
                event.preventDefault();
                navigateToWeek(newWeek, newSeason);
            }
        }

        // Initialize theme button and keyboard navigation
        document.addEventListener('DOMContentLoaded', function() {
            
            const savedTheme = localStorage.getItem('theme') || 'dark';
            const button = document.querySelector('.theme-toggle');
            
            if (savedTheme === 'light') {
                button.textContent = '🌙';
            }

            // Hide/show bonus sections on initial page load with season-specific rules
            const allUserSections = document.querySelectorAll('.user-picks-section');
            allUserSections.forEach(userSection => {
                const thursdaySection = userSection.querySelector('.thursday-section');
                const fridaySection = userSection.querySelector('.friday-section');
                
                if (thursdaySection) {
                    thursdaySection.style.display = shouldShowBonusDay('thursday', currentDisplayedWeek, currentDisplayedSeason) ? 'block' : 'none';
                }
                if (fridaySection) {
                    fridaySection.style.display = shouldShowBonusDay('friday', currentDisplayedWeek, currentDisplayedSeason) ? 'block' : 'none';
                }
            });

            // Update games remaining counter
            const scheduledGames = document.querySelectorAll('.game-card.scheduled').length;
            const gamesRemainingEl = document.getElementById('games-remaining');
            if (gamesRemainingEl) {
                gamesRemainingEl.textContent = scheduledGames;
            }

            // Initialize the games header on page load
            const gamesHeader = document.getElementById('games-header');
            if (gamesHeader) {
                if (currentDisplayedSeason === 2025) {
                    gamesHeader.textContent = `Week ${currentDisplayedWeek} Games`;
                } else {
                    gamesHeader.textContent = `Week ${currentDisplayedWeek} Games (${currentDisplayedSeason})`;
                }
            }

            // Add keyboard navigation listener
            document.addEventListener('keydown', handleKeyboardNavigation);
            
            // Initialize client-side picks display with server-rendered data
            if (initialUserPicksData && initialGamesData) {
                updatePicksDisplay(initialUserPicksData, initialUserData, initialGamesData, currentDisplayedWeek, currentDisplayedSeason);
            }
            
            // Initial page load - data is already rendered by server, no need to reload
            
            // Note: Caching is now handled by the JSON-based dashboard API system
            
            // Preload adjacent weeks in background for faster navigation
            setTimeout(() => {
                // Preload previous week
                let prevWeek = currentDisplayedWeek - 1;
                let prevSeason = currentDisplayedSeason;
                if (prevWeek < 1 && currentDisplayedSeason > MIN_SEASON) {
                    prevWeek = 18;
                    prevSeason = currentDisplayedSeason - 1;
                }
                if (prevWeek >= 1 && prevSeason >= MIN_SEASON) {
                    loadDashboardData(prevWeek, prevSeason).then(data => {
                        if (data && typeof data === 'object' && data.userPicks) {
                            seasonCache[prevSeason][prevWeek] = data;
                            console.log(`Preloaded ${prevSeason} Week ${prevWeek}`);
                        } else {
                            console.warn(`Not preloading invalid data for ${prevSeason} Week ${prevWeek}, type:`, typeof data);
                        }
                    });
                }
                
                // Preload next week
                let nextWeek = currentDisplayedWeek + 1;
                let nextSeason = currentDisplayedSeason;
                if (nextWeek > 18 && currentDisplayedSeason < MAX_SEASON) {
                    nextWeek = 1;
                    nextSeason = currentDisplayedSeason + 1;
                }
                if (nextWeek <= 18 && nextSeason <= MAX_SEASON) {
                    loadDashboardData(nextWeek, nextSeason).then(data => {
                        if (data && typeof data === 'object' && data.userPicks) {
                            seasonCache[nextSeason][nextWeek] = data;
                            console.log(`Preloaded ${nextSeason} Week ${nextWeek}`);
                        } else {
                            console.warn(`Not preloading invalid data for ${nextSeason} Week ${nextWeek}, type:`, typeof data);
                        }
                    });
                }
            }, 1000); // Wait 1s before preloading to let page fully load
        });
    </script>
</body>
</html>